<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Explorer - 2025</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js for simple comparisons -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .transaction-row {
            transition: all 0.2s;
        }

        .transaction-row.excluded {
            opacity: 0.3;
            text-decoration: line-through;
        }

        .transaction-row:not(.excluded):hover {
            background-color: #F3F4F6;
        }

        .comparison-panel {
            transition: all 0.3s;
            border: 2px solid #E5E7EB;
        }

        .comparison-panel:hover {
            border-color: #6366F1;
        }

        select, input {
            transition: all 0.2s;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .filter-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50" x-data="financialExplorer()" x-init="init()">

    <!-- Header -->
    <header class="filter-section text-white shadow-lg">
        <div class="container mx-auto px-6 py-8">
            <h1 class="text-3xl font-bold mb-2">Financial Explorer</h1>
            <p class="text-purple-100 text-sm">Build your custom financial view • <span x-text="allTransactions.length"></span> total transactions</p>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8 max-w-7xl">

        <!-- FILTER SECTION -->
        <section class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Filters</h2>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <!-- Category Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                    <select x-model="mainFilters.category" @change="updateMainView()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">All Categories</option>
                        <template x-for="category in allCategories" :key="category">
                            <option :value="category" x-text="category"></option>
                        </template>
                    </select>
                </div>

                <!-- Date Range -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date Range</label>
                    <select x-model="mainFilters.datePreset" @change="applyDatePreset(); updateMainView();"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="all">All Time</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="ytd">Year to Date</option>
                        <option value="last12">Last 12 Months</option>
                        <option value="last6">Last 6 Months</option>
                        <option value="last3">Last 3 Months</option>
                    </select>
                </div>

                <!-- Owner Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Owner</label>
                    <select x-model="mainFilters.owner" @change="updateMainView()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">All Owners</option>
                        <template x-for="owner in allOwners" :key="owner">
                            <option :value="owner" x-text="owner"></option>
                        </template>
                    </select>
                </div>

                <!-- Include Business -->
                <div class="flex items-end">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" x-model="mainFilters.includeBusiness" @change="updateMainView()"
                               class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                        <span class="ml-2 text-sm font-semibold text-gray-700">Include Business</span>
                    </label>
                </div>
            </div>

            <!-- Reset Button -->
            <div class="flex justify-end">
                <button @click="resetFilters()"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm font-semibold">
                    Reset All
                </button>
            </div>
        </section>

        <!-- SUMMARY CARD -->
        <section class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl shadow-lg p-6 mb-6 text-white">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <p class="text-purple-100 text-sm font-semibold mb-1">Total Amount</p>
                    <p class="stat-value" x-text="formatCurrency(mainViewStats.total)"></p>
                </div>
                <div>
                    <p class="text-purple-100 text-sm font-semibold mb-1">Average</p>
                    <p class="stat-value" x-text="formatCurrency(mainViewStats.average)"></p>
                </div>
                <div>
                    <p class="text-purple-100 text-sm font-semibold mb-1">Transactions</p>
                    <p class="stat-value" x-text="mainViewStats.count"></p>
                </div>
                <div>
                    <p class="text-purple-100 text-sm font-semibold mb-1">Excluded</p>
                    <p class="stat-value" x-text="excludedTransactions.length"></p>
                </div>
            </div>
        </section>

        <!-- TRANSACTIONS TABLE -->
        <section class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Transactions</h2>
                    <p class="text-sm text-gray-600 mt-1">
                        Showing <span class="font-semibold text-purple-600" x-text="displayedTransactions.length"></span>
                        <span x-show="displayedTransactions.length !== allTransactions.length">
                            of <span x-text="allTransactions.length"></span> total
                        </span>
                    </p>
                </div>
                <div class="flex gap-2">
                    <button @click="exportToCSV()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold">
                        Export CSV
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="mb-4">
                <input type="text" x-model="searchQuery" @input="updateMainView()"
                       placeholder="Search transactions..."
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <!-- Table -->
            <div class="overflow-x-auto" style="max-height: 500px; overflow-y: auto;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase">
                                <input type="checkbox" @change="toggleAllTransactions($event)"
                                       class="w-4 h-4 text-purple-600 rounded">
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase">Date</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase">Description</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase">Amount</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase">Category</th>
                            <th class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase">Owner</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="transaction in paginatedTransactions" :key="transaction.id">
                            <tr class="transaction-row"
                                :class="{'excluded': excludedTransactions.includes(transaction.id)}">
                                <td class="px-3 py-4 whitespace-nowrap">
                                    <input type="checkbox"
                                           :checked="!excludedTransactions.includes(transaction.id)"
                                           @change="toggleTransaction(transaction.id)"
                                           class="w-4 h-4 text-purple-600 rounded">
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900" x-text="transaction.date"></td>
                                <td class="px-3 py-4 text-sm text-gray-900" x-text="transaction.description"></td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold"
                                    :class="transaction.amount > 0 ? 'text-red-600' : 'text-green-600'"
                                    x-text="formatCurrency(transaction.amount)"></td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-600" x-text="transaction.category"></td>
                                <td class="px-3 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                          :style="`background-color: ${getOwnerColor(transaction.owner)}20; color: ${getOwnerColor(transaction.owner)}`"
                                          x-text="transaction.owner"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="mt-4 flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    Showing <span x-text="paginationStart"></span> to <span x-text="paginationEnd"></span> of <span x-text="displayedTransactions.length"></span>
                </div>
                <div class="flex gap-2">
                    <button @click="previousPage()" :disabled="currentPage === 1"
                            class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 hover:bg-gray-300 transition">
                        Previous
                    </button>
                    <span class="px-3 py-1 text-sm text-gray-600">
                        Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
                    </span>
                    <button @click="nextPage()" :disabled="currentPage === totalPages"
                            class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 hover:bg-gray-300 transition">
                        Next
                    </button>
                </div>
            </div>
        </section>

        <!-- COMPARISONS SECTION -->
        <section class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Comparisons</h2>
                <button @click="addComparison()"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-semibold">
                    + Add Comparison
                </button>
            </div>

            <div x-show="comparisons.length === 0" class="text-center py-8 text-gray-500">
                <p class="mb-2">No comparisons added yet</p>
                <p class="text-sm">Click "Add Comparison" to compare different categories, time periods, or owners side-by-side</p>
            </div>

            <!-- Comparison Panels -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <template x-for="(comp, index) in comparisons" :key="index">
                    <div class="comparison-panel rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-bold text-gray-700" x-text="'Panel ' + (index + 1)"></h3>
                            <button @click="removeComparison(index)" class="text-red-600 hover:text-red-800 text-sm">
                                &times; Remove
                            </button>
                        </div>

                        <!-- Comparison Filters -->
                        <div class="space-y-2 mb-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Category</label>
                                <select x-model="comp.category" @change="updateComparisons()"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                    <option value="">All</option>
                                    <template x-for="category in allCategories" :key="category">
                                        <option :value="category" x-text="category"></option>
                                    </template>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Date Range</label>
                                <select x-model="comp.datePreset" @change="updateComparisons()"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                    <option value="all">All Time</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="ytd">Year to Date</option>
                                    <option value="last12">Last 12 Months</option>
                                    <option value="last6">Last 6 Months</option>
                                    <option value="last3">Last 3 Months</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Owner</label>
                                <select x-model="comp.owner" @change="updateComparisons()"
                                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                    <option value="">All</option>
                                    <template x-for="owner in allOwners" :key="owner">
                                        <option :value="owner" x-text="owner"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Comparison Stats -->
                        <div class="bg-white rounded p-3 border-t-4" :style="`border-color: ${getComparisonColor(index)}`">
                            <div class="mb-2">
                                <p class="text-xs text-gray-600">Total</p>
                                <p class="text-2xl font-bold" :style="`color: ${getComparisonColor(index)}`"
                                   x-text="formatCurrency(comp.stats.total)"></p>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <p class="text-gray-600">Avg</p>
                                    <p class="font-semibold text-gray-800" x-text="formatCurrency(comp.stats.average)"></p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Count</p>
                                    <p class="font-semibold text-gray-800" x-text="comp.stats.count"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Comparison Chart -->
            <div x-show="comparisons.length > 0" class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-bold text-gray-700 mb-3">Visual Comparison</h3>
                <canvas id="comparisonChart" height="80"></canvas>
            </div>
        </section>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p class="text-sm">Financial Explorer • Generated: {{ data_json.generated_at }}</p>
        </div>
    </footer>

    <!-- Embedded Data -->
    <script>
        const FINANCIAL_DATA = {{ data_json }};
    </script>

    <!-- Alpine.js App Logic -->
    <script>
        function financialExplorer() {
            return {
                // Raw data
                allTransactions: [],
                allOwners: [],
                allCategories: [],
                ownerColors: {},

                // Main view filters
                mainFilters: {
                    category: '',
                    datePreset: 'all',
                    owner: '',
                    includeBusiness: true
                },

                // Excluded transactions
                excludedTransactions: [],

                // Comparisons
                comparisons: [],
                comparisonChart: null,

                // Pagination
                currentPage: 1,
                itemsPerPage: 50,

                // Search
                searchQuery: '',

                // Initialize
                init() {
                    this.allTransactions = FINANCIAL_DATA.transactions;
                    this.ownerColors = FINANCIAL_DATA.owner_colors;
                    this.allOwners = [...new Set(this.allTransactions.map(t => t.owner))];
                    this.allCategories = [...new Set(this.allTransactions.map(t => t.category))].sort();

                    this.updateMainView();
                },

                // Get filtered transactions for main view
                get filteredTransactions() {
                    return this.allTransactions.filter(t => {
                        if (this.excludedTransactions.includes(t.id)) return false;
                        if (this.mainFilters.category && t.category !== this.mainFilters.category) return false;
                        if (this.mainFilters.owner && t.owner !== this.mainFilters.owner) return false;
                        if (!this.mainFilters.includeBusiness && t.is_business) return false;

                        // Date filtering
                        if (!this.matchesDatePreset(t.date, this.mainFilters.datePreset)) return false;

                        return true;
                    });
                },

                // Get displayed transactions (with search)
                get displayedTransactions() {
                    let transactions = this.filteredTransactions;
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        transactions = transactions.filter(t =>
                            t.description.toLowerCase().includes(query) ||
                            t.category.toLowerCase().includes(query) ||
                            t.owner.toLowerCase().includes(query)
                        );
                    }
                    return transactions;
                },

                // Paginated transactions
                get paginatedTransactions() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.displayedTransactions.slice(start, end);
                },

                get totalPages() {
                    return Math.ceil(this.displayedTransactions.length / this.itemsPerPage);
                },

                get paginationStart() {
                    return ((this.currentPage - 1) * this.itemsPerPage) + 1;
                },

                get paginationEnd() {
                    return Math.min(this.currentPage * this.itemsPerPage, this.displayedTransactions.length);
                },

                // Main view stats
                get mainViewStats() {
                    const transactions = this.filteredTransactions;
                    const total = transactions.reduce((sum, t) => sum + t.amount, 0);
                    const average = transactions.length > 0 ? total / transactions.length : 0;
                    return {
                        total: total,
                        average: average,
                        count: transactions.length
                    };
                },

                // Filter methods
                matchesDatePreset(dateStr, preset) {
                    if (preset === 'all') return true;

                    const transactionDate = new Date(dateStr);
                    const now = new Date();

                    switch (preset) {
                        case '2025':
                            return transactionDate.getFullYear() === 2025;
                        case '2024':
                            return transactionDate.getFullYear() === 2024;
                        case '2023':
                            return transactionDate.getFullYear() === 2023;
                        case '2022':
                            return transactionDate.getFullYear() === 2022;
                        case 'ytd':
                            return transactionDate.getFullYear() === now.getFullYear();
                        case 'last12': {
                            const twelveMonthsAgo = new Date();
                            twelveMonthsAgo.setMonth(now.getMonth() - 12);
                            return transactionDate >= twelveMonthsAgo;
                        }
                        case 'last6': {
                            const sixMonthsAgo = new Date();
                            sixMonthsAgo.setMonth(now.getMonth() - 6);
                            return transactionDate >= sixMonthsAgo;
                        }
                        case 'last3': {
                            const threeMonthsAgo = new Date();
                            threeMonthsAgo.setMonth(now.getMonth() - 3);
                            return transactionDate >= threeMonthsAgo;
                        }
                        default:
                            return true;
                    }
                },

                applyDatePreset() {
                    // Trigger update when date preset changes
                    this.updateMainView();
                },

                resetFilters() {
                    this.mainFilters = {
                        category: '',
                        datePreset: 'all',
                        owner: '',
                        includeBusiness: true
                    };
                    this.excludedTransactions = [];
                    this.searchQuery = '';
                    this.currentPage = 1;
                },

                updateMainView() {
                    this.currentPage = 1;
                    // Force reactivity update
                    this.$nextTick();
                },

                // Transaction toggle
                toggleTransaction(id) {
                    const index = this.excludedTransactions.indexOf(id);
                    if (index > -1) {
                        this.excludedTransactions.splice(index, 1);
                    } else {
                        this.excludedTransactions.push(id);
                    }
                    // Update comparisons when transactions are toggled
                    if (this.comparisons.length > 0) {
                        this.updateComparisons();
                    }
                },

                toggleAllTransactions(event) {
                    if (event.target.checked) {
                        this.excludedTransactions = [];
                    } else {
                        this.excludedTransactions = this.displayedTransactions.map(t => t.id);
                    }
                    // Update comparisons when transactions are toggled
                    if (this.comparisons.length > 0) {
                        this.updateComparisons();
                    }
                },

                // Pagination
                nextPage() {
                    if (this.currentPage < this.totalPages) this.currentPage++;
                },

                previousPage() {
                    if (this.currentPage > 1) this.currentPage--;
                },

                // Comparison methods
                addComparison() {
                    this.comparisons.push({
                        category: '',
                        datePreset: 'all',
                        owner: '',
                        stats: { total: 0, average: 0, count: 0 }
                    });
                    this.updateComparisons();
                },

                removeComparison(index) {
                    this.comparisons.splice(index, 1);
                    this.updateComparisons();
                },

                updateComparisons() {
                    this.comparisons.forEach(comp => {
                        const transactions = this.allTransactions.filter(t => {
                            if (this.excludedTransactions.includes(t.id)) return false;
                            if (comp.category && t.category !== comp.category) return false;
                            if (comp.owner && t.owner !== comp.owner) return false;

                            // Date filtering for comparisons
                            if (!this.matchesDatePreset(t.date, comp.datePreset)) return false;

                            return true;
                        });

                        const total = transactions.reduce((sum, t) => sum + t.amount, 0);
                        const average = transactions.length > 0 ? total / transactions.length : 0;

                        comp.stats = {
                            total: total,
                            average: average,
                            count: transactions.length
                        };
                    });

                    this.$nextTick(() => this.renderComparisonChart());
                },

                renderComparisonChart() {
                    if (this.comparisons.length === 0) return;

                    const canvas = document.getElementById('comparisonChart');
                    if (!canvas) {
                        console.error('Canvas element not found');
                        return;
                    }

                    const ctx = canvas.getContext('2d');
                    if (!ctx) {
                        console.error('Could not get canvas context');
                        return;
                    }

                    // Destroy existing chart
                    if (this.comparisonChart) {
                        this.comparisonChart.destroy();
                        this.comparisonChart = null;
                    }

                    try {
                        const labels = this.comparisons.map((comp, i) => {
                            const parts = [];
                            if (comp.category) parts.push(comp.category);
                            if (comp.owner) parts.push(comp.owner);
                            if (comp.datePreset !== 'all') parts.push(comp.datePreset);
                            return parts.length > 0 ? parts.join(' - ') : `Panel ${i + 1}`;
                        });

                        const data = this.comparisons.map(comp => comp.stats.total);
                        const colors = this.comparisons.map((comp, i) => this.getComparisonColor(i));

                        this.comparisonChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Total Amount',
                                    data: data,
                                    backgroundColor: colors,
                                    borderColor: colors,
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return '$' + context.parsed.y.toLocaleString();
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error rendering chart:', error);
                    }
                },

                getComparisonColor(index) {
                    const colors = ['#8B5CF6', '#EC4899', '#10B981', '#F59E0B', '#3B82F6', '#EF4444'];
                    return colors[index % colors.length];
                },

                // Helpers
                formatCurrency(amount) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(amount);
                },

                getOwnerColor(owner) {
                    return this.ownerColors[owner] || '#6B7280';
                },

                // Export
                exportToCSV() {
                    const transactions = this.filteredTransactions;
                    const headers = ['Date', 'Description', 'Amount', 'Category', 'Subcategory', 'Owner', 'Account', 'Type'];

                    let csv = headers.join(',') + '\\n';

                    transactions.forEach(t => {
                        const row = [
                            t.date,
                            `"${t.description.replace(/"/g, '""')}"`,
                            t.amount,
                            t.category,
                            t.sub_category || '',
                            t.owner,
                            t.account_name,
                            t.type
                        ];
                        csv += row.join(',') + '\\n';
                    });

                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'financial_export.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                }
            };
        }
    </script>
</body>
</html>
