<!-- dashboard_budget.html — Kanso redesign -->

<!-- Info strip -->
<div class="kanso-info-strip" style="margin-bottom: 20px;">
  <div class="kanso-info-item">
    <div class="kanso-info-label">Initial Budget</div>
    <div class="kanso-info-value">${{ "%.2f"|format(total_initial_budget) }}</div>
  </div>
  <div class="kanso-info-item">
    <div class="kanso-info-label">Unexpected</div>
    <div class="kanso-info-value {{ 'anl-negative' if total_unexpected_expenses > 0 else 'muted' }}">
      +${{ "%.2f"|format(total_unexpected_expenses) }}
    </div>
  </div>
  <div class="kanso-info-item">
    <div class="kanso-info-label">Effective Budget</div>
    <div class="kanso-info-value">${{ "%.2f"|format(total_effective_budget) }}</div>
  </div>
  <div class="kanso-info-item">
    <div class="kanso-info-label">Actual Spending</div>
    <div class="kanso-info-value {{ 'anl-negative' if total_actual_spending > total_effective_budget else 'anl-positive' }}">
      ${{ "%.2f"|format(total_actual_spending) }}
    </div>
  </div>
</div>

<!-- Budget progress card -->
<div class="kanso-card" style="margin-bottom:20px;">
  <div class="dsh-budget-progress">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
      <div class="kanso-section-label" style="margin-bottom:0;">
        Budget Utilization · {{ ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][current_month-1] }} {{ current_year }}
      </div>
      {% set remaining = total_effective_budget - total_actual_spending %}
      <span style="font-size:13px; color:{{ 'var(--danger)' if remaining < 0 else 'var(--success)' }}; font-weight:600;">
        {% if remaining >= 0 %}${{ "%.0f"|format(remaining) }} remaining{% else %}${{ "%.0f"|format(-remaining) }} over{% endif %}
      </span>
    </div>
    {% set pct = [(total_actual_spending / total_effective_budget * 100) if total_effective_budget > 0 else 0, 100] | min %}
    <div class="kanso-progress-wrap">
      <div class="kanso-progress-bar" style="width:{{ pct }}%; background:{{ 'var(--danger)' if pct >= 100 or total_actual_spending > total_effective_budget else 'var(--warning)' if pct >= 90 else 'var(--success)' }};"></div>
    </div>
    <div class="dsh-budget-progress-sub">
      <span>$0</span>
      <span style="color:var(--text-muted);">${{ "%.0f"|format(total_actual_spending) }} of ${{ "%.0f"|format(total_effective_budget) }}</span>
    </div>
  </div>
</div>

<!-- Budget table card -->
<div class="kanso-card" style="margin-bottom:20px;">
  <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 18px 12px;">
    <div class="kanso-section-label" style="margin-bottom:0;">Budget Details</div>
    <a href="{{ url_for('budgets.budget_management') }}" class="btn-kanso btn-kanso-ghost btn-kanso-sm">Manage Budgets</a>
  </div>

  {% if budget_analysis %}
  <div style="overflow-x:auto; padding:0 0 16px;">
    <table class="anl-table" id="budgetTable">
      <thead>
        <tr>
          <th>Category / Subcategory</th>
          <th style="text-align:right;">Initial</th>
          <th style="text-align:right;">Unexpected</th>
          <th style="text-align:right;">Effective</th>
          <th style="text-align:right;">Actual</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for item in budget_analysis %}
        <!-- Category Row -->
        <tr class="dsh-budget-row {{ 'category-level-budget clickable-category' if item.budget_by_category else 'has-subcategories' }}"
            data-category="{{ item.category }}"
            {% if item.budget_by_category %}
            style="cursor:pointer;"
            onclick="toggleCategoryTransactions(event, '{{ item.category }}')"
            {% endif %}>
          <td style="font-weight:600; padding-left:18px;">
            {% if item.budget_by_category %}
            <svg class="toggle-icon-cat" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" width="10" height="10" style="margin-right:6px; color:var(--text-faint);"><polyline points="3 4 6 7 9 4"/></svg>
            {% elif item.subcategories %}
            <svg class="toggle-icon" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" width="10" height="10" style="margin-right:6px; cursor:pointer; color:var(--text-faint);" onclick="toggleSubcategories('{{ item.category }}')"><polyline points="3 4 6 7 9 4"/></svg>
            {% endif %}
            {{ item.category }}
            {% if item.budget_by_category %}
            <span class="kanso-badge" style="background:var(--primary-dim); color:var(--primary); margin-left:6px; font-size:10px;">Category Budget</span>
            {% endif %}
          </td>
          <td style="text-align:right; color:var(--text-muted);">${{ "%.2f"|format(item.initial_budget) }}</td>
          <td style="text-align:right; color:var(--warning);">
            {% if item.unexpected_expenses > 0 %}+${{ "%.2f"|format(item.unexpected_expenses) }}{% else %}&mdash;{% endif %}
          </td>
          <td style="text-align:right; font-weight:600;">${{ "%.2f"|format(item.effective_budget) }}</td>
          <td class="{{ 'anl-positive' if item.actual_spending <= item.effective_budget else 'anl-negative' }}" style="text-align:right; font-weight:600;">
            ${{ "%.2f"|format(item.actual_spending) }}
          </td>
          <td>
            {% if item.status == 'over' %}
              <span class="kanso-badge" style="background:var(--danger-dim); color:var(--danger);">Over</span>
              <span style="font-size:11px; color:var(--danger); display:block; margin-top:2px;">+${{ "%.0f"|format(item.variance) }}</span>
            {% elif item.status == 'under' %}
              <span class="kanso-badge" style="background:var(--success-dim); color:var(--success);">Under</span>
              <span style="font-size:11px; color:var(--success); display:block; margin-top:2px;">-${{ "%.0f"|format(-item.variance) }}</span>
            {% elif item.status == 'on_track' %}
              <span class="kanso-badge" style="background:var(--primary-dim); color:var(--primary);">On Track</span>
              <span style="font-size:11px; color:var(--text-muted); display:block; margin-top:2px;">
                {% if item.variance > 0 %}+{% endif %}${{ "%.0f"|format(item.variance) }}
              </span>
            {% elif item.status == 'no_budget' %}
              <span class="kanso-badge" style="background:var(--surface-raised); color:var(--text-muted); border:1px solid var(--border);">No Budget</span>
            {% endif %}
          </td>
        </tr>

        <!-- Subcategory Rows -->
        {% if not item.budget_by_category and item.subcategories %}
          {% for subcat in item.subcategories %}
          <tr class="dsh-subcat-row clickable-subcategory"
              data-parent-category="{{ item.category }}"
              data-category="{{ item.category }}"
              data-subcategory="{{ subcat.sub_category }}"
              style="display:none; cursor:pointer;"
              onclick="toggleTransactions(event, '{{ item.category }}', '{{ subcat.sub_category }}')">
            <td style="padding-left:36px; font-size:13px; color:var(--text-muted);">
              <svg class="toggle-icon-trans" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" width="9" height="9" style="margin-right:6px; color:var(--text-faint);"><polyline points="3 4 6 7 9 4"/></svg>
              {{ subcat.sub_category }}
            </td>
            <td style="text-align:right; font-size:13px; color:var(--text-muted);">${{ "%.2f"|format(subcat.budget_amount) }}</td>
            <td style="text-align:right; font-size:13px; color:var(--text-muted);">&mdash;</td>
            <td style="text-align:right; font-size:13px;">${{ "%.2f"|format(subcat.budget_amount) }}</td>
            <td class="{{ 'anl-positive' if subcat.actual_spending <= subcat.budget_amount else 'anl-negative' }}" style="text-align:right; font-size:13px; font-weight:600;">
              ${{ "%.2f"|format(subcat.actual_spending) }}
            </td>
            <td style="font-size:13px;">
              {% if subcat.status == 'over' %}
                <span class="kanso-badge" style="background:var(--danger-dim); color:var(--danger); font-size:10px;">Over</span>
                <span style="font-size:11px; color:var(--danger); display:block; margin-top:2px;">+${{ "%.0f"|format(subcat.variance) }}</span>
              {% elif subcat.status == 'under' %}
                <span class="kanso-badge" style="background:var(--success-dim); color:var(--success); font-size:10px;">Under</span>
                <span style="font-size:11px; color:var(--success); display:block; margin-top:2px;">-${{ "%.0f"|format(-subcat.variance) }}</span>
              {% elif subcat.status == 'on_track' %}
                <span class="kanso-badge" style="background:var(--primary-dim); color:var(--primary); font-size:10px;">On Track</span>
              {% elif subcat.status == 'no_budget' %}
                <span class="kanso-badge" style="background:var(--surface-raised); color:var(--text-muted); border:1px solid var(--border); font-size:10px;">No Budget</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <div style="text-align:center; padding:32px 18px;">
    <div class="kanso-feedback info" style="display:inline-block; margin-bottom:16px;">No budget data available for this period.</div>
    <br>
    <a href="{{ url_for('budgets.budget_management') }}" class="btn-kanso btn-kanso-primary">Set Up Your Budget</a>
  </div>
  {% endif %}
</div>

<!-- Budget charts (only if budget_analysis) -->
{% if budget_analysis %}
<div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
  <div class="kanso-card">
    <div class="dsh-card-header">
      <div class="kanso-section-label" style="margin-bottom:0;">Budget vs Actual</div>
    </div>
    <div id="budgetVsActualChart" class="chart-container"></div>
  </div>
  <div class="kanso-card">
    <div class="dsh-card-header">
      <div class="kanso-section-label" style="margin-bottom:0;">Budget Impact Analysis</div>
    </div>
    <div id="budgetImpactChart" class="chart-container"></div>
  </div>
</div>

<!-- Insights card -->
<div class="kanso-card" style="margin-bottom:20px;">
  <div class="kanso-section-label" style="padding:14px 18px 0;">Insights</div>
  <div class="dsh-insight-grid">

    <!-- Over Budget -->
    {% set over_budget_categories = budget_analysis | selectattr('status', 'equalto', 'over') | list %}
    <div class="kanso-tip-box" style="{{ 'background:var(--danger-dim); border-left-color:var(--danger);' if over_budget_categories|length > 0 else 'background:var(--success-dim); border-left-color:var(--success);' }}">
      <div style="font-weight:600; font-size:12px; color:{{ 'var(--danger)' if over_budget_categories|length > 0 else 'var(--success)' }}; margin-bottom:6px;">
        {% if over_budget_categories|length > 0 %}Over Budget Categories{% else %}Budget Performance{% endif %}
      </div>
      <ul style="margin:0; padding-left:14px; color:var(--text-muted); font-size:12.5px;">
        {% if over_budget_categories %}
          {% for item in over_budget_categories[:3] %}
          <li>{{ item.category }}: ${{ "%.0f"|format(item.variance) }} over</li>
          {% endfor %}
          {% if over_budget_categories|length > 3 %}
          <li><em>...and {{ over_budget_categories|length - 3 }} more</em></li>
          {% endif %}
        {% else %}
          <li>All categories within budget!</li>
          <li>Utilization: {{ "%.1f"|format((total_actual_spending / total_effective_budget * 100) if total_effective_budget > 0 else 0) }}%</li>
        {% endif %}
      </ul>
    </div>

    <!-- Unexpected Impact -->
    <div class="kanso-note-box">
      <div style="font-weight:600; font-size:12px; color:var(--text); margin-bottom:6px;">Unexpected Expenses Impact</div>
      <ul style="margin:0; padding-left:14px; color:var(--text-muted); font-size:12.5px;">
        {% if total_unexpected_expenses > 0 %}
          <li>Added ${{ "%.0f"|format(total_unexpected_expenses) }} to budget</li>
          <li>{{ "%.1f"|format((total_unexpected_expenses / total_initial_budget * 100) if total_initial_budget > 0 else 0) }}% increase from initial</li>
          {% set cats_with_unexpected = budget_analysis | selectattr('unexpected_expenses', 'greaterthan', 0) | list %}
          <li>{{ cats_with_unexpected|length }} categories affected</li>
        {% else %}
          <li>No unexpected expenses this month</li>
          <li>Budget matches initial template</li>
        {% endif %}
      </ul>
    </div>

    <!-- Recommendations -->
    <div class="kanso-tip-box">
      <div style="font-weight:600; font-size:12px; color:var(--primary); margin-bottom:6px;">Recommendations</div>
      {% set over_budget_count = budget_analysis | selectattr('status', 'equalto', 'over') | list | length %}
      {% set on_track_count = budget_analysis | selectattr('status', 'equalto', 'on_track') | list | length %}
      <ul style="margin:0; padding-left:14px; color:var(--text-muted); font-size:12.5px;">
        {% if over_budget_count > 0 %}
          <li>Review {{ over_budget_count }} over-budget categories</li>
        {% endif %}
        {% if total_unexpected_expenses > total_initial_budget * 0.2 %}
          <li>Consider updating initial budgets</li>
        {% endif %}
        {% if on_track_count > over_budget_count %}
          <li>{{ on_track_count }} categories on track</li>
        {% endif %}
        {% if total_actual_spending <= total_effective_budget %}
          <li>Great job staying within budget!</li>
        {% else %}
          <li>Consider adjusting spending or budget</li>
        {% endif %}
      </ul>
    </div>
  </div>

  <!-- Quick Actions -->
  <div style="padding:12px 18px 16px; display:flex; gap:8px; flex-wrap:wrap; border-top:1px solid var(--border-subtle); margin-top:12px;">
    <a href="{{ url_for('budgets.budget_management') }}" class="btn-kanso btn-kanso-ghost btn-kanso-sm">Update Initial Budgets</a>
    <a href="{{ url_for('budgets.budget_management') }}?year={{ current_year }}&month={{ current_month }}" class="btn-kanso btn-kanso-ghost btn-kanso-sm">Manage Unexpected</a>
    <a href="{{ url_for('transactions.add_transaction') }}" class="btn-kanso btn-kanso-ghost btn-kanso-sm">Add Transaction</a>
  </div>
</div>

<script>
// Cache for loaded transactions to avoid redundant API calls
const transactionCache = {};

function toggleSubcategories(category) {
    const subcategoryRows = document.querySelectorAll(`tr.dsh-subcat-row[data-parent-category="${category}"]`);
    const toggleIcon = document.querySelector(`tr.dsh-budget-row[data-category="${category}"] .toggle-icon`);

    subcategoryRows.forEach(row => {
        if (row.style.display === 'none') {
            row.style.display = 'table-row';
            if (toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';
        } else {
            row.style.display = 'none';
            if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';

            const dataCategory = row.getAttribute('data-category');
            const dataSubcategory = row.getAttribute('data-subcategory');
            if (dataCategory && dataSubcategory) {
                const cacheKey = `${dataCategory}|${dataSubcategory}|{{ current_year }}|{{ current_month }}`;
                const transRows = document.querySelectorAll(`tr.dsh-txn-row[data-subcategory-key="${cacheKey}"]`);
                transRows.forEach(tr => tr.remove());

                const subcatIcon = row.querySelector('.toggle-icon-trans');
                if (subcatIcon) subcatIcon.style.transform = 'rotate(0deg)';
            }
        }
    });
}

async function toggleTransactions(event, category, subcategory) {
    event.stopPropagation();

    const subcatRow = event.currentTarget;
    const toggleIcon = subcatRow.querySelector('.toggle-icon-trans');
    const cacheKey = `${category}|${subcategory}|{{ current_year }}|{{ current_month }}`;

    const existingTransRows = document.querySelectorAll(`tr.dsh-txn-row[data-subcategory-key="${cacheKey}"]`);

    if (existingTransRows.length > 0) {
        existingTransRows.forEach(row => row.remove());
        if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
        return;
    }

    if (toggleIcon) toggleIcon.style.transform = 'rotate(90deg)';

    try {
        let data = transactionCache[cacheKey];

        if (!data) {
            const response = await fetch(
                `/api/transactions/by-subcategory?` +
                `category=${encodeURIComponent(category)}&` +
                `subcategory=${encodeURIComponent(subcategory)}&` +
                `year={{ current_year }}&` +
                `month={{ current_month }}&` +
                `owner={{ current_owner }}`
            );

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            data = await response.json();
            transactionCache[cacheKey] = data;
        }

        const transactions = data.transactions;

        if (transactions.length === 0) {
            const noDataRow = document.createElement('tr');
            noDataRow.className = 'dsh-txn-row';
            noDataRow.setAttribute('data-subcategory-key', cacheKey);
            noDataRow.innerHTML = `
                <td colspan="6" style="text-align:center; color:var(--text-muted); font-style:italic; padding-left:52px;">
                    No transactions found for this subcategory
                </td>
            `;
            subcatRow.insertAdjacentElement('afterend', noDataRow);
        } else {
            let lastInsertedRow = subcatRow;
            for (let i = 0; i < transactions.length; i++) {
                const trans = transactions[i];
                const transRow = document.createElement('tr');
                transRow.className = 'dsh-txn-row';
                transRow.setAttribute('data-subcategory-key', cacheKey);

                transRow.innerHTML = `
                    <td style="padding-left:52px;">
                        <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10" style="margin-right:5px; color:var(--text-faint);"><rect x="1" y="1" width="10" height="10" rx="1"/><line x1="3" y1="4" x2="9" y2="4"/><line x1="3" y1="7" x2="7" y2="7"/></svg>
                        ${escapeHtml(trans.description)}
                        <small style="color:var(--text-muted); display:block; font-size:11px; margin-top:1px;">
                            ${formatDate(trans.date)} · ${escapeHtml(trans.account_name)}
                        </small>
                    </td>
                    <td colspan="3"></td>
                    <td style="text-align:right; font-weight:600; color:var(--text);">
                        $${trans.amount.toFixed(2)}
                    </td>
                    <td></td>
                `;

                lastInsertedRow.insertAdjacentElement('afterend', transRow);
                lastInsertedRow = transRow;
            }
        }

        if (toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';

    } catch (error) {
        console.error('Error loading transactions:', error);
        if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
        alert('Failed to load transactions. Please try again.');
    }
}

async function toggleCategoryTransactions(event, category) {
    event.stopPropagation();

    const categoryRow = event.currentTarget;
    const toggleIcon = categoryRow.querySelector('.toggle-icon-cat');
    const cacheKey = `cat|${category}|{{ current_year }}|{{ current_month }}`;

    const existingTransRows = document.querySelectorAll(`tr.dsh-txn-row[data-category-key="${cacheKey}"]`);

    if (existingTransRows.length > 0) {
        existingTransRows.forEach(row => row.remove());
        if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
        return;
    }

    if (toggleIcon) toggleIcon.style.transform = 'rotate(90deg)';

    try {
        let data = transactionCache[cacheKey];

        if (!data) {
            const response = await fetch(
                `/api/transactions/by-subcategory?` +
                `category=${encodeURIComponent(category)}&` +
                `year={{ current_year }}&` +
                `month={{ current_month }}&` +
                `owner={{ current_owner }}`
            );

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            data = await response.json();
            transactionCache[cacheKey] = data;
        }

        const transactions = data.transactions;

        if (transactions.length === 0) {
            const noDataRow = document.createElement('tr');
            noDataRow.className = 'dsh-txn-row';
            noDataRow.setAttribute('data-category-key', cacheKey);
            noDataRow.innerHTML = `
                <td colspan="6" style="text-align:center; color:var(--text-muted); font-style:italic; padding-left:36px;">
                    No transactions found for this category
                </td>
            `;
            categoryRow.insertAdjacentElement('afterend', noDataRow);
        } else {
            let lastInsertedRow = categoryRow;
            for (let i = 0; i < transactions.length; i++) {
                const trans = transactions[i];
                const transRow = document.createElement('tr');
                transRow.className = 'dsh-txn-row';
                transRow.setAttribute('data-category-key', cacheKey);

                transRow.innerHTML = `
                    <td style="padding-left:36px;">
                        <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5" width="10" height="10" style="margin-right:5px; color:var(--primary);"><rect x="1" y="1" width="10" height="10" rx="1"/><line x1="3" y1="4" x2="9" y2="4"/><line x1="3" y1="7" x2="7" y2="7"/></svg>
                        ${escapeHtml(trans.description)}
                        <small style="color:var(--text-muted); display:block; font-size:11px; margin-top:1px;">
                            ${formatDate(trans.date)} · ${escapeHtml(trans.account_name)}
                            ${trans.sub_category ? ' · <em>' + escapeHtml(trans.sub_category) + '</em>' : ''}
                        </small>
                    </td>
                    <td colspan="3"></td>
                    <td style="text-align:right; font-weight:600; color:var(--text);">
                        $${trans.amount.toFixed(2)}
                    </td>
                    <td></td>
                `;

                lastInsertedRow.insertAdjacentElement('afterend', transRow);
                lastInsertedRow = transRow;
            }
        }

        if (toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';

    } catch (error) {
        console.error('Error loading category transactions:', error);
        if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
        alert('Failed to load transactions. Please try again.');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateStr) {
    const [year, month, day] = dateStr.split('-').map(num => parseInt(num, 10));
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[month - 1]} ${day}`;
}

// Budget charts with theme-aware colors
document.addEventListener('DOMContentLoaded', function() {
    const theme = document.documentElement.dataset.theme || 'warm-ink';
    const CHART_COLORS = {
        'warm-ink': { needs: '#7BAF8E', wants: '#D4956A', business: '#6A8FBF', savings: '#A67FB5', primary: '#C49A5E', bg: '#201D18', text: '#F0EBE3', grid: '#332E28', success: '#7BAF8E', danger: '#C96060', warning: '#E8761F' },
        'indigo':   { needs: '#7BAF8E', wants: '#D4956A', business: '#6A8FBF', savings: '#A67FB5', primary: '#7B9ED9', bg: '#1A1F2C', text: '#E8EDF7', grid: '#252B3B', success: '#7BAF8E', danger: '#C96060', warning: '#E8761F' },
        'washi':    { needs: '#4A8B60', wants: '#B86A3A', business: '#3A6A9F', savings: '#7A5A9F', primary: '#8C6A3F', bg: '#FFFFFF', text: '#2C2622', grid: '#DDD9D2', success: '#4A8B60', danger: '#B04040', warning: '#C86010' }
    };
    const colors = CHART_COLORS[theme] || CHART_COLORS['warm-ink'];

    const budgetData = window.budgetAnalysisData || [];
    if (!budgetData.length) return;

    const categories = budgetData.map(d => d.category);
    const effective  = budgetData.map(d => d.effectiveBudget);
    const actual     = budgetData.map(d => d.actualSpending);
    const statuses   = budgetData.map(d => d.status);

    const barColors = statuses.map(s =>
        s === 'over' ? colors.danger : s === 'under' ? colors.success : colors.primary
    );

    // Budget vs Actual chart
    if (document.getElementById('budgetVsActualChart')) {
        Plotly.newPlot('budgetVsActualChart', [
            {
                name: 'Effective Budget',
                x: effective,
                y: categories,
                type: 'bar',
                orientation: 'h',
                marker: { color: colors.grid || '#555', opacity: 0.6 },
                hovertemplate: '<b>%{y}</b><br>Budget: $%{x:.2f}<extra></extra>'
            },
            {
                name: 'Actual Spending',
                x: actual,
                y: categories,
                type: 'bar',
                orientation: 'h',
                marker: { color: barColors },
                hovertemplate: '<b>%{y}</b><br>Actual: $%{x:.2f}<extra></extra>'
            }
        ], {
            barmode: 'overlay',
            paper_bgcolor: colors.bg,
            plot_bgcolor: colors.bg,
            font: { color: colors.text, size: 11 },
            xaxis: { color: colors.text, gridcolor: colors.grid, title: 'Amount ($)' },
            yaxis: { color: colors.text, automargin: true },
            legend: { font: { color: colors.text } },
            margin: { t: 20, r: 20, b: 40, l: 10 },
            height: 300
        }, { responsive: true, displayModeBar: false });
    }

    // Budget Impact Analysis chart
    if (document.getElementById('budgetImpactChart')) {
        const initial    = budgetData.map(d => d.initialBudget);
        const unexpected = budgetData.map(d => d.unexpectedExpenses);

        Plotly.newPlot('budgetImpactChart', [
            {
                name: 'Initial Budget',
                x: categories,
                y: initial,
                type: 'bar',
                marker: { color: colors.primary, opacity: 0.8 },
                hovertemplate: '<b>%{x}</b><br>Initial: $%{y:.2f}<extra></extra>'
            },
            {
                name: 'Unexpected',
                x: categories,
                y: unexpected,
                type: 'bar',
                marker: { color: colors.warning, opacity: 0.8 },
                hovertemplate: '<b>%{x}</b><br>Unexpected: $%{y:.2f}<extra></extra>'
            }
        ], {
            barmode: 'stack',
            paper_bgcolor: colors.bg,
            plot_bgcolor: colors.bg,
            font: { color: colors.text, size: 11 },
            xaxis: { color: colors.text, gridcolor: colors.grid, tickangle: -30 },
            yaxis: { color: colors.text, gridcolor: colors.grid, title: 'Amount ($)' },
            legend: { font: { color: colors.text } },
            margin: { t: 20, r: 20, b: 60, l: 10 },
            height: 300
        }, { responsive: true, displayModeBar: false });
    }
});
</script>
{% endif %}
