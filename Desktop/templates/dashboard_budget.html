<!-- dashboard_budget.html - Fixed Template Syntax -->
<!-- Budget Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-label">Initial Budget</div>
            <div class="metric-value neutral">${{ "%.2f"|format(total_initial_budget) }}</div>
            <small class="text-muted">Template Monthly</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-label">Unexpected Expenses</div>
            <div class="metric-value negative">${{ "%.2f"|format(total_unexpected_expenses) }}</div>
            <small class="text-muted">{{ current_year }}-{{ "%02d"|format(current_month) }}</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-label">Effective Budget</div>
            <div class="metric-value neutral">${{ "%.2f"|format(total_effective_budget) }}</div>
            <small class="text-muted">Initial + Unexpected</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-label">Actual Spending</div>
            <div class="metric-value {{ 'positive' if total_actual_spending <= total_effective_budget else 'negative' }}">
                ${{ "%.2f"|format(total_actual_spending) }}
            </div>
            <small class="text-muted">Current Month</small>
        </div>
    </div>
</div>

<!-- Budget Flow Visualization -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìä Budget Flow for {{ current_year }}-{{ "%02d"|format(current_month) }}</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <div class="budget-flow-step">
                            <div class="budget-flow-amount text-primary">${{ "%.0f"|format(total_initial_budget) }}</div>
                            <div class="budget-flow-label">Initial Budget</div>
                        </div>
                    </div>
                    <div class="col-md-1 text-center">
                        <i class="fas fa-plus text-muted fa-2x"></i>
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="budget-flow-step">
                            <div class="budget-flow-amount text-warning">${{ "%.0f"|format(total_unexpected_expenses) }}</div>
                            <div class="budget-flow-label">Unexpected</div>
                        </div>
                    </div>
                    <div class="col-md-1 text-center">
                        <i class="fas fa-equals text-muted fa-2x"></i>
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="budget-flow-step">
                            <div class="budget-flow-amount text-info">${{ "%.0f"|format(total_effective_budget) }}</div>
                            <div class="budget-flow-label">Effective Budget</div>
                        </div>
                    </div>
                    <div class="col-md-1 text-center">
                        <i class="fas fa-arrow-right text-muted fa-2x"></i>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="budget-flow-step">
                            <div class="budget-flow-amount {{ 'text-success' if total_actual_spending <= total_effective_budget else 'text-danger' }}">
                                ${{ "%.0f"|format(total_actual_spending) }}
                            </div>
                            <div class="budget-flow-label">Actual Spending</div>
                            <div class="budget-flow-status {{ 'text-success' if total_actual_spending <= total_effective_budget else 'text-danger' }}">
                                {% set difference = total_effective_budget - total_actual_spending %}
                                {% if difference > 0 %}
                                    ${{ "%.0f"|format(difference) }} remaining
                                {% elif difference == 0 %}
                                    On budget
                                {% else %}
                                    ${{ "%.0f"|format(-difference) }} over budget
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Budget Management Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üí∞ Budget Details</h5>
                <div>
                    <a href="{{ url_for('budgets.budget_management') }}" class="btn btn-outline-primary btn-sm">
                        üìã Manage Initial Budgets
                    </a>
                    <a href="{{ url_for('budgets.budget_management') }}?year={{ current_year }}&month={{ current_month }}" class="btn btn-outline-warning btn-sm">
                        üí∏ Manage Unexpected Expenses
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if budget_analysis %}
                <div class="table-responsive">
                    <table class="table table-hover" id="budgetTable">
                        <thead>
                            <tr>
                                <th>Category / Subcategory</th>
                                <th>Initial Budget</th>
                                <th>Unexpected</th>
                                <th>Effective Budget</th>
                                <th>Actual Spending</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in budget_analysis %}
                            <!-- Category Row -->
                            <tr class="budget-row {{ 'category-level-budget' if item.budget_by_category else 'has-subcategories' }}"
                                data-category="{{ item.category }}"
                                style="background-color: {{ '#f8f9fa' if not item.budget_by_category else 'inherit' }};">
                                <td class="fw-bold">
                                    {% if not item.budget_by_category and item.subcategories %}
                                    <i class="fas fa-chevron-right toggle-icon me-2" style="cursor: pointer;" onclick="toggleSubcategories('{{ item.category }}')"></i>
                                    {% endif %}
                                    {{ item.category }}
                                    {% if item.budget_by_category %}
                                    <span class="badge bg-info ms-2" style="font-size: 0.7rem;">Category Budget</span>
                                    {% endif %}
                                </td>
                                <td class="text-primary">${{ "%.2f"|format(item.initial_budget) }}</td>
                                <td class="text-warning">
                                    {% if item.unexpected_expenses > 0 %}
                                        +${{ "%.2f"|format(item.unexpected_expenses) }}
                                    {% else %}
                                        $0.00
                                    {% endif %}
                                </td>
                                <td class="text-info fw-bold">${{ "%.2f"|format(item.effective_budget) }}</td>
                                <td class="fw-bold {{ 'text-success' if item.actual_spending <= item.effective_budget else 'text-danger' }}">
                                    ${{ "%.2f"|format(item.actual_spending) }}
                                </td>
                                <td>
                                    {% if item.status == 'over' %}
                                        <span class="badge bg-danger">Over Budget</span>
                                        <small class="d-block text-danger">+${{ "%.0f"|format(item.variance) }}</small>
                                    {% elif item.status == 'under' %}
                                        <span class="badge bg-success">Under Budget</span>
                                        <small class="d-block text-success">-${{ "%.0f"|format(-item.variance) }}</small>
                                    {% elif item.status == 'on_track' %}
                                        <span class="badge bg-primary">On Track</span>
                                        <small class="d-block text-muted">
                                            {% if item.variance > 0 %}
                                                +${{ "%.0f"|format(item.variance) }}
                                            {% else %}
                                                ${{ "%.0f"|format(item.variance) }}
                                            {% endif %}
                                        </small>
                                    {% elif item.status == 'no_budget' %}
                                        <span class="badge bg-secondary">No Budget</span>
                                    {% endif %}
                                </td>
                            </tr>

                            <!-- Subcategory Rows (only for subcategory-level budgets) -->
                            {% if not item.budget_by_category and item.subcategories %}
                                {% for subcat in item.subcategories %}
                                <tr class="subcategory-row clickable-subcategory"
                                    data-parent-category="{{ item.category }}"
                                    data-category="{{ item.category }}"
                                    data-subcategory="{{ subcat.sub_category }}"
                                    style="display: none; cursor: pointer;"
                                    onclick="toggleTransactions(event, '{{ item.category }}', '{{ subcat.sub_category }}')">
                                    <td class="ps-5" style="font-size: 0.9rem;">
                                        <i class="fas fa-chevron-right toggle-icon-trans me-2 text-muted" style="font-size: 0.75rem;"></i>{{ subcat.sub_category }}
                                    </td>
                                    <td class="text-primary" style="font-size: 0.9rem;">${{ "%.2f"|format(subcat.budget_amount) }}</td>
                                    <td class="text-muted" style="font-size: 0.9rem;">-</td>
                                    <td class="text-info" style="font-size: 0.9rem;">${{ "%.2f"|format(subcat.budget_amount) }}</td>
                                    <td style="font-size: 0.9rem;" class="{{ 'text-success' if subcat.actual_spending <= subcat.budget_amount else 'text-danger' }}">
                                        ${{ "%.2f"|format(subcat.actual_spending) }}
                                    </td>
                                    <td style="font-size: 0.9rem;">
                                        {% if subcat.status == 'over' %}
                                            <span class="badge bg-danger" style="font-size: 0.7rem;">Over</span>
                                            <small class="d-block text-danger">+${{ "%.0f"|format(subcat.variance) }}</small>
                                        {% elif subcat.status == 'under' %}
                                            <span class="badge bg-success" style="font-size: 0.7rem;">Under</span>
                                            <small class="d-block text-success">-${{ "%.0f"|format(-subcat.variance) }}</small>
                                        {% elif subcat.status == 'on_track' %}
                                            <span class="badge bg-primary" style="font-size: 0.7rem;">On Track</span>
                                        {% elif subcat.status == 'no_budget' %}
                                            <span class="badge bg-secondary" style="font-size: 0.7rem;">No Budget</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <style>
                .clickable-subcategory:hover {
                    background-color: #e9ecef !important;
                }

                .transaction-row {
                    border-left: 3px solid #6c757d;
                    background-color: #f8f9fa !important;
                }

                .transaction-row:hover {
                    background-color: #e9ecef !important;
                }

                .ps-7 {
                    padding-left: 4rem !important;
                }
                </style>

                <script>
                // Cache for loaded transactions to avoid redundant API calls
                const transactionCache = {};

                function toggleSubcategories(category) {
                    // Find all subcategory rows for this category
                    const subcategoryRows = document.querySelectorAll(`tr.subcategory-row[data-parent-category="${category}"]`);
                    const toggleIcon = document.querySelector(`tr.budget-row[data-category="${category}"] .toggle-icon`);

                    // Toggle visibility
                    subcategoryRows.forEach(row => {
                        if (row.style.display === 'none') {
                            row.style.display = 'table-row';
                            toggleIcon.classList.remove('fa-chevron-right');
                            toggleIcon.classList.add('fa-chevron-down');
                        } else {
                            row.style.display = 'none';
                            toggleIcon.classList.remove('fa-chevron-down');
                            toggleIcon.classList.add('fa-chevron-right');

                            // ALSO collapse any open transactions when category is collapsed
                            const dataCategory = row.getAttribute('data-category');
                            const dataSubcategory = row.getAttribute('data-subcategory');
                            if (dataCategory && dataSubcategory) {
                                const cacheKey = `${dataCategory}|${dataSubcategory}|{{ current_year }}|{{ current_month }}`;
                                const transRows = document.querySelectorAll(`tr.transaction-row[data-subcategory-key="${cacheKey}"]`);
                                transRows.forEach(tr => tr.remove());

                                // Reset subcategory toggle icon
                                const subcatIcon = row.querySelector('.toggle-icon-trans');
                                if (subcatIcon) {
                                    subcatIcon.classList.remove('fa-chevron-down', 'fa-spinner', 'fa-spin');
                                    subcatIcon.classList.add('fa-chevron-right');
                                }
                            }
                        }
                    });
                }

                async function toggleTransactions(event, category, subcategory) {
                    event.stopPropagation(); // Prevent row click bubbling

                    const subcatRow = event.currentTarget;
                    const toggleIcon = subcatRow.querySelector('.toggle-icon-trans');
                    const cacheKey = `${category}|${subcategory}|{{ current_year }}|{{ current_month }}`;

                    // Check if transactions are already displayed
                    const existingTransRows = document.querySelectorAll(`tr.transaction-row[data-subcategory-key="${cacheKey}"]`);

                    if (existingTransRows.length > 0) {
                        // Collapse - remove transaction rows
                        existingTransRows.forEach(row => row.remove());
                        toggleIcon.classList.remove('fa-chevron-down');
                        toggleIcon.classList.add('fa-chevron-right');
                        return;
                    }

                    // Expand - fetch and display transactions
                    toggleIcon.classList.remove('fa-chevron-right');
                    toggleIcon.classList.add('fa-spinner', 'fa-spin');

                    try {
                        // Check cache first
                        let data = transactionCache[cacheKey];

                        if (!data) {
                            // Fetch from API
                            const response = await fetch(
                                `/api/transactions/by-subcategory?` +
                                `category=${encodeURIComponent(category)}&` +
                                `subcategory=${encodeURIComponent(subcategory)}&` +
                                `year={{ current_year }}&` +
                                `month={{ current_month }}&` +
                                `owner={{ current_owner }}`
                            );

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            data = await response.json();
                            transactionCache[cacheKey] = data; // Cache the response
                        }

                        const transactions = data.transactions;

                        if (transactions.length === 0) {
                            // No transactions found - show a message row
                            const noDataRow = document.createElement('tr');
                            noDataRow.className = 'transaction-row';
                            noDataRow.setAttribute('data-subcategory-key', cacheKey);
                            noDataRow.innerHTML = `
                                <td colspan="6" class="text-center text-muted ps-7" style="font-size: 0.85rem; font-style: italic;">
                                    No transactions found for this subcategory
                                </td>
                            `;
                            subcatRow.insertAdjacentElement('afterend', noDataRow);
                        } else {
                            // Create transaction rows and keep track of last inserted row
                            let lastInsertedRow = subcatRow;
                            for (let i = 0; i < transactions.length; i++) {
                                const trans = transactions[i];
                                const transRow = document.createElement('tr');
                                transRow.className = 'transaction-row';
                                transRow.setAttribute('data-subcategory-key', cacheKey);

                                transRow.innerHTML = `
                                    <td class="ps-7" style="font-size: 0.85rem;">
                                        <i class="fas fa-receipt me-2 text-muted" style="font-size: 0.7rem;"></i>
                                        ${escapeHtml(trans.description)}
                                        <small class="text-muted d-block" style="font-size: 0.75rem;">
                                            ${formatDate(trans.date)} ‚Ä¢ ${escapeHtml(trans.account_name)}
                                        </small>
                                    </td>
                                    <td colspan="3" style="font-size: 0.85rem;"></td>
                                    <td class="text-end fw-bold" style="font-size: 0.85rem;">
                                        $${trans.amount.toFixed(2)}
                                    </td>
                                    <td style="font-size: 0.85rem;"></td>
                                `;

                                // Insert after the last inserted row
                                lastInsertedRow.insertAdjacentElement('afterend', transRow);
                                lastInsertedRow = transRow; // Update reference for next iteration
                            }
                        }

                        // Update icon to expanded state
                        toggleIcon.classList.remove('fa-spinner', 'fa-spin');
                        toggleIcon.classList.add('fa-chevron-down');

                    } catch (error) {
                        console.error('Error loading transactions:', error);
                        toggleIcon.classList.remove('fa-spinner', 'fa-spin');
                        toggleIcon.classList.add('fa-chevron-right');
                        alert('Failed to load transactions. Please try again.');
                    }
                }

                // Helper function to escape HTML to prevent XSS
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                // Helper function to format date nicely (without timezone conversion)
                function formatDate(dateStr) {
                    // Parse date string directly to avoid timezone issues
                    // dateStr format: "YYYY-MM-DD"
                    const [year, month, day] = dateStr.split('-').map(num => parseInt(num, 10));
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${months[month - 1]} ${day}`;
                }
                </script>
                {% else %}
                <div class="text-center py-4">
                    <p class="text-muted mb-3">No budget data available for this period.</p>
                    <a href="{{ url_for('budgets.budget_management') }}" class="btn btn-primary">
                        üìã Set Up Your Budget
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Budget Charts -->
{% if budget_analysis %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìä Budget vs Actual</h5>
            </div>
            <div class="card-body">
                <div id="budgetVsActualChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìà Budget Impact Analysis</h5>
            </div>
            <div class="card-body">
                <div id="budgetImpactChart" class="chart-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- Budget Insights -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üí° Budget Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        {% set over_budget_categories = budget_analysis | selectattr('status', 'equalto', 'over') | list %}
                        <div class="alert alert-{{ 'danger' if over_budget_categories|length > 0 else 'success' }}">
                            <h6>{% if over_budget_categories|length > 0 %}‚ö†Ô∏è Over Budget Categories{% else %}‚úÖ Budget Performance{% endif %}</h6>
                            <ul class="mb-0">
                                {% if over_budget_categories %}
                                    {% for item in over_budget_categories[:3] %}
                                    <li>{{ item.category }}: ${{ "%.0f"|format(item.variance) }} over</li>
                                    {% endfor %}
                                    {% if over_budget_categories|length > 3 %}
                                    <li><em>...and {{ over_budget_categories|length - 3 }} more</em></li>
                                    {% endif %}
                                {% else %}
                                    <li>All categories within budget! üéâ</li>
                                    <li>Total budget utilization: {{ "%.1f"|format((total_actual_spending / total_effective_budget * 100) if total_effective_budget > 0 else 0) }}%</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h6>üí∏ Unexpected Expenses Impact</h6>
                            <ul class="mb-0">
                                {% if total_unexpected_expenses > 0 %}
                                    <li>Added ${{ "%.0f"|format(total_unexpected_expenses) }} to budget</li>
                                    <li>{{ "%.1f"|format(total_unexpected_expenses / total_initial_budget * 100) if total_initial_budget > 0 else 0 }}% increase from initial</li>
                                    {% set categories_with_unexpected = budget_analysis | selectattr('unexpected_expenses', 'greaterthan', 0) | list %}
                                    <li>{{ categories_with_unexpected|length }} categories affected</li>
                                {% else %}
                                    <li>No unexpected expenses this month! üëç</li>
                                    <li>Budget matches initial template</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="alert alert-warning">
                            <h6>üìã Recommendations</h6>
                            {% set over_budget_count = budget_analysis | selectattr('status', 'equalto', 'over') | list | length %}
                            {% set under_budget_count = budget_analysis | selectattr('status', 'equalto', 'under') | list | length %}
                            {% set on_track_count = budget_analysis | selectattr('status', 'equalto', 'on_track') | list | length %}
                            <ul class="mb-0">
                                {% if over_budget_count > 0 %}
                                    <li>Review {{ over_budget_count }} over-budget categories</li>
                                {% endif %}
                                {% if total_unexpected_expenses > total_initial_budget * 0.2 %}
                                    <li>Consider updating initial budgets</li>
                                {% endif %}
                                {% if on_track_count > over_budget_count %}
                                    <li>{{ on_track_count }} categories on track! üëç</li>
                                {% endif %}
                                {% if total_actual_spending <= total_effective_budget %}
                                    <li>Great job staying within budget!</li>
                                {% else %}
                                    <li>Consider adjusting spending or budget</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Budget Actions -->
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>üöÄ Quick Actions:</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="{{ url_for('budgets.budget_management') }}" class="btn btn-outline-primary btn-sm">
                                üìã Update Initial Budgets
                            </a>
                            <a href="{{ url_for('budgets.budget_management') }}?year={{ current_year }}&month={{ current_month }}" class="btn btn-outline-warning btn-sm">
                                üí∏ Manage Unexpected Expenses
                            </a>
                            <a href="{{ url_for('transactions.add_transaction') }}" class="btn btn-outline-success btn-sm">
                                üí∞ Add Transaction
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}