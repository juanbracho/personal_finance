{% extends "base.html" %}
{% block title %}Settings — Kanso{% endblock %}

{% block content %}
<div class="kanso-page">

    <!-- Page header -->
    <div class="kanso-page-header">
        <h1 class="kanso-page-title">Settings</h1>
        <p class="kanso-page-subtitle">App, data, and database management</p>
    </div>

    <!-- ── App status strip ── -->
    <div class="kanso-info-strip">
        <div class="kanso-info-item">
            <div class="kanso-info-label">Version</div>
            <div class="kanso-info-value primary">v{{ version }}</div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Database</div>
            <div class="kanso-info-value">
                {% if db_exists %}
                    <span class="status-dot green"></span>Active
                {% else %}
                    <span class="status-dot amber"></span>Not found
                {% endif %}
            </div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Size</div>
            <div class="kanso-info-value {{ 'muted' if not db_exists }}">
                {% if db_exists and db_size %}{{ "%.2f"|format(db_size / 1024 / 1024) }} MB{% else %}—{% endif %}
            </div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Last modified</div>
            <div class="kanso-info-value muted">
                {% if db_exists and db_modified %}
                    {{ db_modified.strftime('%b %-d, %Y') }}
                {% else %}
                    —
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ── Appearance ── -->
    <div class="kanso-section">
        <div class="kanso-section-label">Appearance</div>
        <div class="kanso-card">
            <div class="theme-picker">
                <!-- Warm Ink -->
                <button class="theme-option" data-theme-pick="warm-ink" onclick="setTheme('warm-ink')">
                    <div class="theme-swatch">
                        <span style="background:#141210;"></span>
                        <span style="background:#C49A5E;"></span>
                        <span style="background:#7BAF8E;"></span>
                        <span style="background:#D4956A;"></span>
                    </div>
                    <div class="theme-option-name">Warm Ink</div>
                    <div class="theme-option-desc">Dark · Japanese aesthetic</div>
                </button>
                <!-- Indigo -->
                <button class="theme-option" data-theme-pick="indigo" onclick="setTheme('indigo')">
                    <div class="theme-swatch">
                        <span style="background:#0F1117;"></span>
                        <span style="background:#7B9ED9;"></span>
                        <span style="background:#7BAF8E;"></span>
                        <span style="background:#A67FB5;"></span>
                    </div>
                    <div class="theme-option-name">Indigo</div>
                    <div class="theme-option-desc">Dark · Structured, cooler</div>
                </button>
                <!-- Washi Paper -->
                <button class="theme-option" data-theme-pick="washi" onclick="setTheme('washi')">
                    <div class="theme-swatch">
                        <span style="background:#F7F4EF;"></span>
                        <span style="background:#8C6A3F;"></span>
                        <span style="background:#4A8B60;"></span>
                        <span style="background:#B86A3A;"></span>
                    </div>
                    <div class="theme-option-name">Washi Paper</div>
                    <div class="theme-option-desc">Light · Warm off-white</div>
                </button>
            </div>
        </div>
    </div>

    <!-- ── Data management ── -->
    <div class="kanso-section">
        <div class="kanso-section-label">Data Management</div>

        <!-- Railway / cloud hosting notice -->
        <div class="kanso-tip-box" style="margin-bottom:12px; background:var(--warning-dim); border-left-color:var(--warning);">
            <div style="font-weight:600; color:var(--warning); margin-bottom:4px;">Cloud Hosting Notice</div>
            <div style="font-size:12.5px; color:var(--text-muted);">
                If running on Railway (or any container platform), the server filesystem resets on every redeploy or restart.
                <strong style="color:var(--text);">Export Database → keep the .db file locally → Import if you need to restore</strong> is the only safe backup flow
                unless you have a persistent <strong style="color:var(--text);">Railway Volume</strong> mounted at <code>data/</code>.
                "Create Local Backup" and the backup history below are useful for local/self-hosted installs only.
            </div>
        </div>

        <div class="kanso-card">

            <!-- Export -->
            <div class="kanso-row">
                <div class="kanso-row-icon success">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 3v9m0 0l-3-3m3 3l3-3"/>
                        <path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/>
                    </svg>
                </div>
                <div class="kanso-row-body">
                    <div class="kanso-row-title">Export Database</div>
                    <div class="kanso-row-desc">Download a timestamped backup to your Downloads folder</div>
                </div>
                <div class="kanso-row-action">
                    <button id="downloadBtn"
                            onclick="downloadDatabase()"
                            class="btn-kanso btn-kanso-ghost"
                            {% if not db_exists %}disabled{% endif %}>
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 3v9m0 0l-3-3m3 3l3-3"/>
                            <path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/>
                        </svg>
                        Download
                    </button>
                </div>
            </div>
            <div id="downloadFeedback" class="kanso-feedback success" style="display:none; margin:0 18px 12px;">
                <i class="fas fa-check-circle"></i>
                <span id="downloadMessage"></span>
            </div>

            <!-- Export My Data -->
            <div class="kanso-row">
                <div class="kanso-row-icon" style="color:var(--primary);">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 3v9m0 0l-3-3m3 3l3-3"/>
                        <path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/>
                        <circle cx="10" cy="10" r="7" stroke-dasharray="2 2" opacity="0.4"/>
                    </svg>
                </div>
                <div class="kanso-row-body">
                    <div class="kanso-row-title">Export My Data</div>
                    <div class="kanso-row-desc">Download only your own data as a JSON file</div>
                </div>
                <div class="kanso-row-action">
                    <a href="{{ url_for('settings.export_my_data') }}"
                       class="btn-kanso btn-kanso-ghost">
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="15" height="15">
                            <path d="M10 3v9m0 0l-3-3m3 3l3-3"/>
                            <path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/>
                        </svg>
                        Download
                    </a>
                </div>
            </div>

            <!-- Import -->
            <div class="kanso-row">
                <div class="kanso-row-icon">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 14V5m0 0L7 8m3-3l3 3"/>
                        <path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/>
                    </svg>
                </div>
                <div class="kanso-row-body">
                    <div class="kanso-row-title">Import Database</div>
                    <div class="kanso-row-desc">Restore from a <code>.db</code> backup — current data is backed up first</div>
                </div>
                <div class="kanso-row-action">
                    <form action="{{ url_for('settings.upload_database') }}"
                          method="POST"
                          enctype="multipart/form-data"
                          id="importForm"
                          style="display:flex; align-items:center; gap:8px;">
                        <label class="kanso-file-label" for="database_file">
                            <svg width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
                                <path d="M4 4h7l5 5v9H4z"/><path d="M11 4v5h5"/>
                            </svg>
                            Choose file
                        </label>
                        <span class="kanso-file-name" id="importFileName">No file chosen</span>
                        <input type="file"
                               id="database_file"
                               name="database_file"
                               accept=".db"
                               required
                               style="display:none;"
                               onchange="document.getElementById('importFileName').textContent = this.files[0]?.name || 'No file chosen'">
                        <button type="submit"
                                class="btn-kanso btn-kanso-primary"
                                onclick="return confirm('This will replace your current database. A backup will be created first. Continue?')">
                            Upload
                        </button>
                    </form>
                </div>
            </div>

            <!-- Create local backup -->
            <div class="kanso-row">
                <div class="kanso-row-icon warning">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 10a7 7 0 1014 0A7 7 0 003 10z"/>
                        <path d="M10 7v3l2 2"/>
                    </svg>
                </div>
                <div class="kanso-row-body">
                    <div class="kanso-row-title">Create Local Backup</div>
                    <div class="kanso-row-desc">Saved to <code>data/backups/</code> inside the app</div>
                </div>
                <div class="kanso-row-action">
                    <form action="{{ url_for('settings.create_backup') }}" method="POST">
                        <button type="submit"
                                class="btn-kanso btn-kanso-ghost"
                                {% if not db_exists %}disabled{% endif %}>
                            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 10a7 7 0 1014 0A7 7 0 003 10z"/>
                                <path d="M10 7v3l2 2"/>
                            </svg>
                            Create
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <!-- ── Backup history ── -->
    <div class="kanso-section">
        <div class="kanso-section-label">Backup History</div>
        <div class="kanso-card">
            {% if backups %}
            <ul class="backup-list">
                {% for backup in backups %}
                <li class="backup-item">
                    <div class="backup-item-icon">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h7l5 5v9H4z"/><path d="M11 4v5h5"/>
                        </svg>
                    </div>
                    <div class="backup-item-name" title="{{ backup.filename }}">{{ backup.filename }}</div>
                    <div class="backup-item-meta">{{ "%.2f"|format(backup.size / 1024 / 1024) }} MB &nbsp;·&nbsp; {{ backup.created.strftime('%b %-d, %Y') }}</div>
                    <div class="backup-item-actions">
                        <form action="{{ url_for('settings.restore_backup', filename=backup.filename) }}" method="POST" style="display:inline;">
                            <button type="submit"
                                    class="btn-kanso btn-kanso-ghost btn-kanso-sm"
                                    onclick="return confirm('Replace current database with this backup?')">
                                Restore
                            </button>
                        </form>
                        <form action="{{ url_for('settings.delete_backup', filename=backup.filename) }}" method="POST" style="display:inline;">
                            <button type="submit"
                                    class="btn-kanso btn-kanso-danger btn-kanso-sm"
                                    onclick="return confirm('Delete this backup?')">
                                Delete
                            </button>
                        </form>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div style="padding:20px 18px; font-size:13.5px; color:var(--text-faint); text-align:center;">
                No local backups yet — create one above.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ── Danger zone ── -->
    <div class="kanso-section mt-section">
        <div class="kanso-section-label" style="color:var(--danger); opacity:0.7;">Danger Zone</div>
        <div class="kanso-danger-card">
            <div class="kanso-danger-header">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 3L2 17h16L10 3z"/>
                    <line x1="10" y1="9" x2="10" y2="12"/>
                    <circle cx="10" cy="14.5" r="0.5" fill="currentColor"/>
                </svg>
                Delete All Data
            </div>
            <div class="kanso-danger-body">
                <p style="font-size:13.5px; color:var(--text-muted); margin:0 0 14px;">
                    Permanently deletes all financial data from the database.
                    A backup is created automatically before deletion.
                    <strong style="color:var(--text);">This cannot be easily undone.</strong>
                </p>
                <form action="{{ url_for('settings.delete_all_data') }}" method="POST" id="deleteForm">
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <label style="font-size:13px; color:var(--text-muted); white-space:nowrap;">
                            Type <code>DELETE ALL DATA</code> to confirm:
                        </label>
                        <input type="text"
                               class="kanso-input"
                               id="confirmation"
                               name="confirmation"
                               placeholder="DELETE ALL DATA"
                               required
                               style="max-width:240px;">
                        <button type="submit"
                                class="btn-kanso btn-kanso-danger-solid"
                                {% if not db_exists %}disabled{% endif %}
                                onclick="return confirmDelete()">
                            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 5h10l-1 12H6L5 5z"/>
                                <path d="M3 5h14M8 5V3h4v2"/>
                            </svg>
                            Delete permanently
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div><!-- /kanso-page -->
{% endblock %}

{% block extra_js %}
<script>
// ── Update system — kept for future use ───────────────────
function selectUpdateFile() {
    document.getElementById('updateFileInput').click();
}

function handleUpdateFileSelected() {
    const fileInput = document.getElementById('updateFileInput');
    const file = fileInput.files[0];
    if (!file) return;

    if (!file.name.endsWith('.zip')) {
        showUpdateError('Invalid file type. Please select a .zip update package.');
        fileInput.value = '';
        return;
    }

    if (!confirm(`Install update from: ${file.name}\n\nMake sure you've exported your database first.\n\nContinue?`)) {
        fileInput.value = '';
        return;
    }

    uploadUpdatePackage(file);
}

function uploadUpdatePackage(file) {
    document.getElementById('updateNormalState').style.display = 'none';
    document.getElementById('updateProgressState').style.display = 'block';
    document.getElementById('updateErrorState').style.display = 'none';
    document.getElementById('updateSuccessState').style.display = 'none';

    setUpdateProgress(10, 'Uploading update package…');

    const formData = new FormData();
    formData.append('update_file', file);

    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            setUpdateProgress(Math.round((e.loaded / e.total) * 50), 'Uploading…');
        }
    });

    xhr.addEventListener('load', () => {
        try {
            const response = JSON.parse(xhr.responseText);
            if (xhr.status === 200 && response.success) {
                setUpdateProgress(100, 'Update installed successfully!');
                setTimeout(() => {
                    document.getElementById('updateProgressState').style.display = 'none';
                    document.getElementById('updateSuccessState').style.display = 'block';
                    document.getElementById('updateSuccessMessage').textContent = response.message || 'Update complete.';
                    if (response.restarting) showRestartCountdown();
                }, 500);
            } else {
                showUpdateError(response.message || `Server error (${xhr.status}).`);
            }
        } catch(e) {
            showUpdateError(`Server error (${xhr.status}). Invalid response.`);
        }
    });

    xhr.addEventListener('error', () => {
        showUpdateError('Network error. Please check your connection.');
    });

    xhr.open('POST', '{{ url_for("settings.install_update") }}');
    xhr.send(formData);

    setTimeout(() => setUpdateProgress(60, 'Validating package…'), 1000);
    setTimeout(() => setUpdateProgress(75, 'Extracting files…'), 2000);
    setTimeout(() => setUpdateProgress(90, 'Installing…'), 3000);
}

function setUpdateProgress(percent, message) {
    document.getElementById('updateProgressBar').style.width = percent + '%';
    document.getElementById('updateStatusMessage').textContent = message;
}

function showUpdateError(message) {
    document.getElementById('updateNormalState').style.display = 'none';
    document.getElementById('updateProgressState').style.display = 'none';
    document.getElementById('updateErrorState').style.display = 'block';
    document.getElementById('updateErrorMessage').textContent = message;
    document.getElementById('updateFileInput').value = '';
}

function resetUpdateUI() {
    document.getElementById('updateNormalState').style.display = 'flex';
    document.getElementById('updateProgressState').style.display = 'none';
    document.getElementById('updateErrorState').style.display = 'none';
    document.getElementById('updateSuccessState').style.display = 'none';
    document.getElementById('updateFileInput').value = '';
}

function showRestartCountdown() {
    let n = 5;
    const el = document.getElementById('updateSuccessMessage');
    const id = setInterval(() => {
        el.textContent = `Update successful! Restarting in ${n}s…`;
        if (--n < 0) {
            clearInterval(id);
            el.textContent = 'Restarting…';
            setTimeout(checkAppReconnection, 2000);
        }
    }, 1000);
}

function checkAppReconnection() {
    const el = document.getElementById('updateSuccessMessage');
    el.textContent = 'Waiting for app to restart…';
    let attempts = 0;
    const id = setInterval(() => {
        fetch('{{ url_for("settings.index") }}')
            .then(r => {
                if (r.ok) {
                    clearInterval(id);
                    el.textContent = 'Update complete! Reloading…';
                    setTimeout(() => window.location.reload(), 1000);
                }
            })
            .catch(() => {
                if (++attempts >= 30) {
                    clearInterval(id);
                    el.textContent = 'Update complete! Please refresh the page manually.';
                }
            });
    }, 1000);
}

// ── Database export ────────────────────────────────────────
function downloadDatabase() {
    const btn = document.getElementById('downloadBtn');
    const feedback = document.getElementById('downloadFeedback');
    const message = document.getElementById('downloadMessage');

    btn.innerHTML = `<svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" width="15" height="15"><path d="M10 3v9m0 0l-3-3m3 3l3-3"/><path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/></svg> Exporting…`;
    btn.disabled = true;
    feedback.style.display = 'none';

    const now = new Date();
    const ts = now.getFullYear()
        + String(now.getMonth()+1).padStart(2,'0')
        + String(now.getDate()).padStart(2,'0') + '_'
        + String(now.getHours()).padStart(2,'0')
        + String(now.getMinutes()).padStart(2,'0')
        + String(now.getSeconds()).padStart(2,'0');
    const filename = `kanso_backup_${ts}.db`;

    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = '{{ url_for("settings.download_database") }}';
    document.body.appendChild(iframe);

    setTimeout(() => {
        btn.innerHTML = `<svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" width="15" height="15"><path d="M10 3v9m0 0l-3-3m3 3l3-3"/><path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/></svg> Download`;
        btn.disabled = false;
        message.textContent = `Exported as ${filename}`;
        feedback.style.display = 'flex';
        setTimeout(() => { if (iframe.parentNode) document.body.removeChild(iframe); }, 2000);
        setTimeout(() => { feedback.style.display = 'none'; }, 10000);
    }, 1000);
}

// ── Delete confirmation ────────────────────────────────────
function confirmDelete() {
    const val = document.getElementById('confirmation').value;
    if (val !== 'DELETE ALL DATA') {
        alert('Please type "DELETE ALL DATA" exactly to confirm.');
        return false;
    }
    return confirm('Final warning: this will delete ALL financial data.\nA backup will be created first, but this is not easily reversible.\n\nContinue?');
}
</script>
{% endblock %}
