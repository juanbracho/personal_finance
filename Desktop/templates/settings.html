{% extends "base.html" %}
{% block title %}Settings — Kanso{% endblock %}

{% block content %}
<div class="kanso-page">

    <!-- Page header -->
    <div class="kanso-page-header">
        <h1 class="kanso-page-title">Settings</h1>
        <p class="kanso-page-subtitle">App, data, and database management</p>
    </div>

    <!-- ── App status strip ── -->
    <div class="kanso-info-strip">
        <div class="kanso-info-item">
            <div class="kanso-info-label">Version</div>
            <div class="kanso-info-value primary">v{{ version }}</div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Database</div>
            <div class="kanso-info-value">
                {% if db_exists %}
                    <span class="status-dot green"></span>Active
                {% else %}
                    <span class="status-dot amber"></span>Not found
                {% endif %}
            </div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Size</div>
            <div class="kanso-info-value {{ 'muted' if not db_exists }}">
                {% if db_exists and db_size %}{{ "%.2f"|format(db_size / 1024 / 1024) }} MB{% else %}—{% endif %}
            </div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Last modified</div>
            <div class="kanso-info-value muted">
                {% if db_exists and db_modified %}
                    {{ db_modified.strftime('%b %-d, %Y') }}
                {% else %}
                    —
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ── Appearance ── -->
    <div class="kanso-section">
        <div class="kanso-section-label">Appearance</div>
        <div class="kanso-card">
            <div class="theme-picker">
                <!-- Warm Ink -->
                <button class="theme-option" data-theme-pick="warm-ink" onclick="setTheme('warm-ink')">
                    <div class="theme-swatch">
                        <span style="background:#141210;"></span>
                        <span style="background:#C49A5E;"></span>
                        <span style="background:#7BAF8E;"></span>
                        <span style="background:#D4956A;"></span>
                    </div>
                    <div class="theme-option-name">Warm Ink</div>
                    <div class="theme-option-desc">Dark · Japanese aesthetic</div>
                </button>
                <!-- Indigo -->
                <button class="theme-option" data-theme-pick="indigo" onclick="setTheme('indigo')">
                    <div class="theme-swatch">
                        <span style="background:#0F1117;"></span>
                        <span style="background:#7B9ED9;"></span>
                        <span style="background:#7BAF8E;"></span>
                        <span style="background:#A67FB5;"></span>
                    </div>
                    <div class="theme-option-name">Indigo</div>
                    <div class="theme-option-desc">Dark · Structured, cooler</div>
                </button>
                <!-- Washi Paper -->
                <button class="theme-option" data-theme-pick="washi" onclick="setTheme('washi')">
                    <div class="theme-swatch">
                        <span style="background:#F7F4EF;"></span>
                        <span style="background:#8C6A3F;"></span>
                        <span style="background:#4A8B60;"></span>
                        <span style="background:#B86A3A;"></span>
                    </div>
                    <div class="theme-option-name">Washi Paper</div>
                    <div class="theme-option-desc">Light · Warm off-white</div>
                </button>
            </div>
        </div>
    </div>

    <!-- ── Data management ── -->
    <div class="kanso-section">
        <div class="kanso-section-label">Data Management</div>

        {% if local_mode %}
        <div class="kanso-tip-box" style="margin-bottom:12px;">
            <div style="font-size:12.5px; color:var(--text-muted);">
                Running in local mode. Your database: Neon / local PostgreSQL.
            </div>
        </div>
        {% else %}
        <div class="kanso-tip-box" style="margin-bottom:12px;">
            <div style="font-size:12.5px; color:var(--text-muted);">
                Your data is securely stored in the cloud. Export a personal copy anytime.
            </div>
        </div>
        {% endif %}

        <div class="kanso-card">

            <!-- Export My Data — always shown -->
            <div class="kanso-row">
                <div class="kanso-row-icon success">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 3v9m0 0l-3-3m3 3l3-3"/>
                        <path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/>
                    </svg>
                </div>
                <div class="kanso-row-body">
                    <div class="kanso-row-title">Export My Data</div>
                    <div class="kanso-row-desc">Download all your financial data as a JSON file</div>
                </div>
                <div class="kanso-row-action">
                    <a href="{{ url_for('settings.export_my_data') }}"
                       class="btn-kanso btn-kanso-ghost">
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="15" height="15">
                            <path d="M10 3v9m0 0l-3-3m3 3l3-3"/>
                            <path d="M3 14v1a2 2 0 002 2h10a2 2 0 002-2v-1"/>
                        </svg>
                        Download
                    </a>
                </div>
            </div>

            {% if local_mode %}
            <!-- Create Local Backup — local mode only -->
            <div class="kanso-row">
                <div class="kanso-row-icon warning">
                    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 10a7 7 0 1014 0A7 7 0 003 10z"/>
                        <path d="M10 7v3l2 2"/>
                    </svg>
                </div>
                <div class="kanso-row-body">
                    <div class="kanso-row-title">Create Local Backup</div>
                    <div class="kanso-row-desc">Save a JSON backup to <code>data/backups/</code> on this machine</div>
                </div>
                <div class="kanso-row-action">
                    <form action="{{ url_for('settings.create_backup') }}" method="POST">
                        <button type="submit" class="btn-kanso btn-kanso-ghost">
                            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 10a7 7 0 1014 0A7 7 0 003 10z"/>
                                <path d="M10 7v3l2 2"/>
                            </svg>
                            Create
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}

        </div>
    </div>

    <!-- ── Backup history — local mode only ── -->
    {% if local_mode %}
    <div class="kanso-section">
        <div class="kanso-section-label">Backup History</div>
        <div class="kanso-card">
            {% if backups %}
            <ul class="backup-list">
                {% for backup in backups %}
                <li class="backup-item">
                    <div class="backup-item-icon">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h7l5 5v9H4z"/><path d="M11 4v5h5"/>
                        </svg>
                    </div>
                    <div class="backup-item-name" title="{{ backup.filename }}">{{ backup.filename }}</div>
                    <div class="backup-item-meta">{{ "%.1f"|format(backup.size / 1024) }} KB &nbsp;·&nbsp; {{ backup.created.strftime('%b %-d, %Y') }}</div>
                    <div class="backup-item-actions">
                        <a href="{{ url_for('settings.restore_backup', filename=backup.filename) }}"
                           class="btn-kanso btn-kanso-ghost btn-kanso-sm">
                            Download
                        </a>
                        <form action="{{ url_for('settings.delete_backup', filename=backup.filename) }}" method="POST" style="display:inline;">
                            <button type="submit"
                                    class="btn-kanso btn-kanso-danger btn-kanso-sm"
                                    onclick="return confirm('Delete this backup?')">
                                Delete
                            </button>
                        </form>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div style="padding:20px 18px; font-size:13.5px; color:var(--text-faint); text-align:center;">
                No local backups yet — create one above.
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ── Administration (admin only) ── -->
    {% if users is not none %}
    <div class="kanso-section">
        <div class="kanso-section-label" style="display:flex; justify-content:space-between; align-items:center;">
            <span>Administration</span>
            <a href="{{ url_for('admin.audit_logs') }}" class="btn-kanso btn-kanso-ghost btn-kanso-sm">
                <i class="fas fa-list-alt" style="font-size:11px;"></i> Audit Logs
            </a>
        </div>

        <!-- Users table -->
        <div class="kanso-card">
            <table class="kanso-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th style="text-align:right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <!-- User row -->
                    <tr>
                        <td style="font-weight:600;">{{ u.username }}</td>
                        <td style="color:var(--text-muted);">{{ u.email or '—' }}</td>
                        <td>
                            {% if u.role == 'admin' %}
                            <span style="font-size:11px; background:var(--primary-dim,rgba(196,154,94,0.15)); color:var(--primary); padding:2px 8px; border-radius:99px; font-weight:600;">admin</span>
                            {% else %}
                            <span style="font-size:11px; color:var(--text-muted);">member</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if u.is_active %}
                            <span class="status-dot green"></span>Active
                            {% else %}
                            <span class="status-dot red"></span><span style="color:var(--text-muted);">Inactive</span>
                            {% endif %}
                        </td>
                        <td style="color:var(--text-muted); font-size:12.5px;">
                            {{ u.created_at.strftime('%b %-d, %Y') if u.created_at else '—' }}
                        </td>
                        <td style="text-align:right;">
                            <div style="display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap;">
                                <!-- Activate / Deactivate -->
                                {% if u.id != session.get('user_id') %}
                                    {% if u.is_active %}
                                    <form action="{{ url_for('admin.deactivate_user', user_id=u.id) }}" method="POST">
                                        <button type="submit"
                                                class="btn-kanso btn-kanso-ghost btn-kanso-sm"
                                                onclick="return confirm('Deactivate {{ u.username }}?')">
                                            Deactivate
                                        </button>
                                    </form>
                                    {% else %}
                                    <form action="{{ url_for('admin.activate_user', user_id=u.id) }}" method="POST">
                                        <button type="submit" class="btn-kanso btn-kanso-ghost btn-kanso-sm">Activate</button>
                                    </form>
                                    {% endif %}
                                {% endif %}
                                <!-- Change password -->
                                <button class="btn-kanso btn-kanso-ghost btn-kanso-sm"
                                        onclick="togglePwdForm({{ u.id }})">
                                    Change Pwd
                                </button>
                                <!-- Delete — not available for self -->
                                {% if u.id != session.get('user_id') %}
                                <form action="{{ url_for('admin.delete_user', user_id=u.id) }}" method="POST">
                                    <button type="submit"
                                            class="btn-kanso btn-kanso-danger btn-kanso-sm"
                                            onclick="return confirm('Delete {{ u.username }} and ALL their data permanently?')">
                                        Delete
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    <!-- Inline change-password form (hidden by default) -->
                    <tr id="pwd-form-{{ u.id }}" style="display:none;">
                        <td colspan="6" style="padding:12px 16px; background:var(--surface-raised); border-bottom:1px solid var(--border-subtle);">
                            <form action="{{ url_for('admin.change_password', user_id=u.id) }}" method="POST"
                                  style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                                <span style="font-size:13px; color:var(--text-muted);">
                                    New password for <strong style="color:var(--text);">{{ u.username }}</strong>:
                                </span>
                                <input type="password" name="new_password"
                                       class="kanso-input" placeholder="Min 8 characters"
                                       required minlength="8"
                                       style="max-width:220px;">
                                <button type="submit" class="btn-kanso btn-kanso-primary btn-kanso-sm">Set Password</button>
                                <button type="button" class="btn-kanso btn-kanso-ghost btn-kanso-sm"
                                        onclick="togglePwdForm({{ u.id }})">Cancel</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align:center; color:var(--text-faint); padding:24px;">No users found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Create user form -->
        <div class="kanso-card" style="padding:20px;">
            <div style="font-size:12px; font-weight:600; letter-spacing:.07em; text-transform:uppercase; color:var(--text-muted); margin-bottom:14px;">Create New User</div>
            <form action="{{ url_for('admin.create_user') }}" method="POST">
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:12px; align-items:end;">
                    <div>
                        <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:4px;">Username <span style="color:var(--danger);">*</span></label>
                        <input type="text" name="username" class="kanso-input" placeholder="e.g. alice" required autocomplete="off" style="width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:4px;">Password <span style="color:var(--danger);">*</span></label>
                        <input type="password" name="password" class="kanso-input" placeholder="••••••••" required autocomplete="new-password" style="width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:4px;">Email <span style="color:var(--text-faint);">(optional)</span></label>
                        <input type="email" name="email" class="kanso-input" placeholder="alice@example.com" autocomplete="off" style="width:100%;">
                    </div>
                    <div>
                        <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:4px;">Role</label>
                        <select name="role" class="kanso-input" style="width:100%;">
                            <option value="member">Member</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:14px;">
                    <button type="submit" class="btn-kanso btn-kanso-primary">
                        <i class="fas fa-user-plus" style="font-size:11px;"></i> Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- ── Danger zone ── -->
    <div class="kanso-section mt-section">
        <div class="kanso-section-label" style="color:var(--danger); opacity:0.7;">Danger Zone</div>
        <div class="kanso-danger-card">
            <div class="kanso-danger-header">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10 3L2 17h16L10 3z"/>
                    <line x1="10" y1="9" x2="10" y2="12"/>
                    <circle cx="10" cy="14.5" r="0.5" fill="currentColor"/>
                </svg>
                Delete All Data
            </div>
            <div class="kanso-danger-body">
                <p style="font-size:13.5px; color:var(--text-muted); margin:0 0 8px;">
                    {% if local_mode %}
                    Permanently deletes all financial data from the database.
                    {% else %}
                    Permanently deletes all your financial data.
                    {% endif %}
                    <strong style="color:var(--text);">This cannot be undone.</strong>
                </p>
                <p style="font-size:13px; color:var(--text-muted); margin:0 0 16px;">
                    We recommend downloading a backup before continuing. &nbsp;
                    <a href="{{ url_for('settings.export_my_data') }}"
                       style="color:var(--primary); text-decoration:none; font-weight:500;">
                        Download backup →
                    </a>
                </p>
                <form action="{{ url_for('settings.delete_all_data') }}" method="POST" id="deleteForm">
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <label style="font-size:13px; color:var(--text-muted); white-space:nowrap;">
                            Type <code>DELETE ALL DATA</code> to confirm:
                        </label>
                        <input type="text"
                               class="kanso-input"
                               id="confirmation"
                               name="confirmation"
                               placeholder="DELETE ALL DATA"
                               required
                               style="max-width:240px;">
                        <button type="submit"
                                class="btn-kanso btn-kanso-danger-solid"
                                {% if not db_exists %}disabled{% endif %}
                                onclick="return confirmDelete()">
                            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 5h10l-1 12H6L5 5z"/>
                                <path d="M3 5h14M8 5V3h4v2"/>
                            </svg>
                            Delete permanently
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div><!-- /kanso-page -->
{% endblock %}

{% block extra_js %}
<script>
// ── Update system — kept for future use ───────────────────
function selectUpdateFile() {
    document.getElementById('updateFileInput').click();
}

function handleUpdateFileSelected() {
    const fileInput = document.getElementById('updateFileInput');
    const file = fileInput.files[0];
    if (!file) return;

    if (!file.name.endsWith('.zip')) {
        showUpdateError('Invalid file type. Please select a .zip update package.');
        fileInput.value = '';
        return;
    }

    if (!confirm(`Install update from: ${file.name}\n\nMake sure you've exported your database first.\n\nContinue?`)) {
        fileInput.value = '';
        return;
    }

    uploadUpdatePackage(file);
}

function uploadUpdatePackage(file) {
    document.getElementById('updateNormalState').style.display = 'none';
    document.getElementById('updateProgressState').style.display = 'block';
    document.getElementById('updateErrorState').style.display = 'none';
    document.getElementById('updateSuccessState').style.display = 'none';

    setUpdateProgress(10, 'Uploading update package…');

    const formData = new FormData();
    formData.append('update_file', file);

    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            setUpdateProgress(Math.round((e.loaded / e.total) * 50), 'Uploading…');
        }
    });

    xhr.addEventListener('load', () => {
        try {
            const response = JSON.parse(xhr.responseText);
            if (xhr.status === 200 && response.success) {
                setUpdateProgress(100, 'Update installed successfully!');
                setTimeout(() => {
                    document.getElementById('updateProgressState').style.display = 'none';
                    document.getElementById('updateSuccessState').style.display = 'block';
                    document.getElementById('updateSuccessMessage').textContent = response.message || 'Update complete.';
                    if (response.restarting) showRestartCountdown();
                }, 500);
            } else {
                showUpdateError(response.message || `Server error (${xhr.status}).`);
            }
        } catch(e) {
            showUpdateError(`Server error (${xhr.status}). Invalid response.`);
        }
    });

    xhr.addEventListener('error', () => {
        showUpdateError('Network error. Please check your connection.');
    });

    xhr.open('POST', '{{ url_for("settings.install_update") }}');
    xhr.send(formData);

    setTimeout(() => setUpdateProgress(60, 'Validating package…'), 1000);
    setTimeout(() => setUpdateProgress(75, 'Extracting files…'), 2000);
    setTimeout(() => setUpdateProgress(90, 'Installing…'), 3000);
}

function setUpdateProgress(percent, message) {
    document.getElementById('updateProgressBar').style.width = percent + '%';
    document.getElementById('updateStatusMessage').textContent = message;
}

function showUpdateError(message) {
    document.getElementById('updateNormalState').style.display = 'none';
    document.getElementById('updateProgressState').style.display = 'none';
    document.getElementById('updateErrorState').style.display = 'block';
    document.getElementById('updateErrorMessage').textContent = message;
    document.getElementById('updateFileInput').value = '';
}

function resetUpdateUI() {
    document.getElementById('updateNormalState').style.display = 'flex';
    document.getElementById('updateProgressState').style.display = 'none';
    document.getElementById('updateErrorState').style.display = 'none';
    document.getElementById('updateSuccessState').style.display = 'none';
    document.getElementById('updateFileInput').value = '';
}

function showRestartCountdown() {
    let n = 5;
    const el = document.getElementById('updateSuccessMessage');
    const id = setInterval(() => {
        el.textContent = `Update successful! Restarting in ${n}s…`;
        if (--n < 0) {
            clearInterval(id);
            el.textContent = 'Restarting…';
            setTimeout(checkAppReconnection, 2000);
        }
    }, 1000);
}

function checkAppReconnection() {
    const el = document.getElementById('updateSuccessMessage');
    el.textContent = 'Waiting for app to restart…';
    let attempts = 0;
    const id = setInterval(() => {
        fetch('{{ url_for("settings.index") }}')
            .then(r => {
                if (r.ok) {
                    clearInterval(id);
                    el.textContent = 'Update complete! Reloading…';
                    setTimeout(() => window.location.reload(), 1000);
                }
            })
            .catch(() => {
                if (++attempts >= 30) {
                    clearInterval(id);
                    el.textContent = 'Update complete! Please refresh the page manually.';
                }
            });
    }, 1000);
}

// ── Admin — inline password form toggle ───────────────────
function togglePwdForm(userId) {
    const row = document.getElementById('pwd-form-' + userId);
    row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}

// ── Delete confirmation ────────────────────────────────────
function confirmDelete() {
    const val = document.getElementById('confirmation').value;
    if (val !== 'DELETE ALL DATA') {
        alert('Please type "DELETE ALL DATA" exactly to confirm.');
        return false;
    }
    return confirm('Final warning: this will delete ALL financial data.\nA backup will be created first, but this is not easily reversible.\n\nContinue?');
}
</script>
{% endblock %}
