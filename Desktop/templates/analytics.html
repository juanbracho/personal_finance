{% extends "base.html" %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/analytics.css') }}" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
{% endblock %}

{% block title %}Analytics — Kanso{% endblock %}

{% block content %}
<div class="kanso-page-wide">

    <!-- Page Header -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
        <div>
            <div class="kanso-section-label" style="margin-bottom:4px;">Finance</div>
            <h1 style="font-size:22px; font-weight:700; color:var(--text); margin:0;">Analytics</h1>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn-kanso btn-kanso-ghost" id="toggleFilters">Filters</button>
            <button class="btn-kanso btn-kanso-ghost" id="resetFilters">Reset</button>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="kanso-card" id="filterPanel" style="margin-bottom:16px; padding:0; overflow:hidden;">
        <div style="padding:12px 18px; border-bottom:1px solid var(--border-subtle);">
            <span style="font-size:13px; font-weight:600; color:var(--text);">Filter Options</span>
        </div>
        <div style="padding:16px 18px;">
            <form id="analyticsFilters">

                <!-- Row 1 — Date + Presets -->
                <div style="display:flex; align-items:flex-end; gap:16px; flex-wrap:wrap; margin-bottom:16px;">
                    <div>
                        <label class="kanso-form-label" for="startDate">Start Date</label>
                        <input type="date" class="kanso-input" id="startDate" value="{{ default_start_date }}">
                    </div>
                    <div>
                        <label class="kanso-form-label" for="endDate">End Date</label>
                        <input type="date" class="kanso-input" id="endDate" value="{{ default_end_date }}">
                    </div>
                    <div>
                        <label class="kanso-form-label">Quick Presets</label>
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <button type="button" class="btn-kanso btn-kanso-ghost btn-kanso-sm" data-preset="this-month">This Month</button>
                            <button type="button" class="btn-kanso btn-kanso-ghost btn-kanso-sm" data-preset="90">3 Months</button>
                            <button type="button" class="btn-kanso btn-kanso-ghost btn-kanso-sm" data-preset="365">This Year</button>
                            <button type="button" class="btn-kanso btn-kanso-ghost btn-kanso-sm" data-preset="last-year">Last Year</button>
                        </div>
                    </div>
                </div>

                <!-- Row 2 — Multi-selects (5-col grid) -->
                <div style="display:grid; grid-template-columns:repeat(5,1fr); gap:16px; margin-bottom:16px;">
                    <div>
                        <label class="kanso-form-label" for="ownersFilter">Owners</label>
                        <select class="kanso-select" id="ownersFilter" multiple size="3">
                            <option value="all" selected>All Owners</option>
                            {% for owner in available_owners %}
                            <option value="{{ owner }}">{{ owner }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="kanso-form-label" for="categoriesFilter">Categories</label>
                        <select class="kanso-select" id="categoriesFilter" multiple size="3">
                            <option value="all" selected>All Categories</option>
                            {% for category in available_categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="kanso-form-label" for="subcategoriesFilter">Subcategories</label>
                        <select class="kanso-select" id="subcategoriesFilter" multiple size="3">
                            <option value="all" selected>All Subcategories</option>
                            {% for subcategory in available_subcategories %}
                            <option value="{{ subcategory.subcategory }}" data-category="{{ subcategory.category }}">{{ subcategory.subcategory }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="kanso-form-label" for="accountsFilter">Accounts</label>
                        <select class="kanso-select" id="accountsFilter" multiple size="3">
                            <option value="all" selected>All Accounts</option>
                            {% for account in available_accounts %}
                            <option value="{{ account }}">{{ account }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="kanso-form-label" for="typesFilter">Types</label>
                        <select class="kanso-select" id="typesFilter" multiple size="3">
                            <option value="all" selected>All Types</option>
                            <option value="Needs">Needs</option>
                            <option value="Wants">Wants</option>
                            <option value="Savings">Savings</option>
                            <option value="Business">Business</option>
                        </select>
                    </div>
                </div>

                <!-- Row 3 — Amount range + Actions -->
                <div style="display:flex; align-items:flex-end; gap:16px; flex-wrap:wrap;">
                    <div>
                        <label class="kanso-form-label" for="minAmount">Min Amount</label>
                        <div class="kanso-input-group">
                            <span class="kanso-input-affix prefix">$</span>
                            <input type="number" class="kanso-input has-prefix" id="minAmount" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div>
                        <label class="kanso-form-label" for="maxAmount">Max Amount</label>
                        <div class="kanso-input-group">
                            <span class="kanso-input-affix prefix">$</span>
                            <input type="number" class="kanso-input has-prefix" id="maxAmount" step="0.01" placeholder="No limit">
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button type="button" class="btn-kanso btn-kanso-primary" id="applyFilters">Apply Filters</button>
                        <button type="button" class="btn-kanso btn-kanso-ghost" id="clearFilters">Clear All</button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" style="display:none; margin-bottom:16px;">
        <div style="text-align:center; padding:32px 0;">
            <div class="spinner-border text-center" role="status" style="color:var(--primary);">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p style="margin-top:10px; color:var(--text-muted); font-size:13.5px;">Updating charts with your filters…</p>
        </div>
    </div>

    <!-- Monthly Spending Matrix -->
    <div class="kanso-card" style="padding:0; overflow:hidden; margin-bottom:16px;">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 18px; border-bottom:1px solid var(--border-subtle); flex-wrap:wrap; gap:10px;">
            <span style="font-size:13px; font-weight:600; color:var(--text);">Year-Over-Year Monthly Spending</span>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="anl-view-toggle">
                    <input type="radio" id="yoyViewYearly" name="yoyViewType" value="yearly" checked
                           style="position:absolute;opacity:0;width:0;height:0;">
                    <label for="yoyViewYearly" class="anl-view-btn active">Yearly Total</label>
                    <input type="radio" id="yoyViewCategory" name="yoyViewType" value="category"
                           style="position:absolute;opacity:0;width:0;height:0;">
                    <label for="yoyViewCategory" class="anl-view-btn">Filtered View</label>
                </div>
                <div id="yoyCategorySelector" style="display:none;">
                    <select class="kanso-select" id="yoyCategorySelect" style="min-width:200px;">
                        <option value="">Select Filter...</option>
                    </select>
                </div>
            </div>
        </div>
        <div style="padding:16px 18px;">
            <div id="monthlySpendingMatrixContainer">
                <div style="text-align:center; color:var(--text-muted); font-size:13.5px;">Loading table…</div>
            </div>
        </div>
    </div>

    <!-- 2×2 Data Table Grid -->
    <div class="row g-3" style="margin-bottom:16px;">

        <!-- Top 10 Categories by Amount -->
        <div class="col-md-6">
            <div class="kanso-card" style="padding:0; overflow:hidden; height:100%;">
                <div style="padding:12px 18px; border-bottom:1px solid var(--border-subtle);">
                    <span style="font-size:13px; font-weight:600; color:var(--text);">Top 10 Categories by Amount</span>
                </div>
                <div style="max-height:420px; overflow-y:auto;">
                    <table class="anl-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody id="categoryAmountsTable">
                            <tr><td colspan="4" style="text-align:center; color:var(--text-muted);">Loading…</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top 10 Categories by Transactions -->
        <div class="col-md-6">
            <div class="kanso-card" style="padding:0; overflow:hidden; height:100%;">
                <div style="padding:12px 18px; border-bottom:1px solid var(--border-subtle);">
                    <span style="font-size:13px; font-weight:600; color:var(--text);">Top 10 Categories by Transactions</span>
                </div>
                <div style="max-height:420px; overflow-y:auto;">
                    <table class="anl-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Category</th>
                                <th>Count</th>
                                <th>Avg</th>
                            </tr>
                        </thead>
                        <tbody id="categoryCountsTable">
                            <tr><td colspan="4" style="text-align:center; color:var(--text-muted);">Loading…</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top 10 Subcategories by Amount -->
        <div class="col-md-6">
            <div class="kanso-card" style="padding:0; overflow:hidden; height:100%;">
                <div style="padding:12px 18px; border-bottom:1px solid var(--border-subtle);">
                    <span style="font-size:13px; font-weight:600; color:var(--text);">Top 10 Subcategories by Amount</span>
                </div>
                <div style="max-height:420px; overflow-y:auto;">
                    <table class="anl-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Subcategory</th>
                                <th>Amount</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody id="subcategoryAmountsTable">
                            <tr><td colspan="4" style="text-align:center; color:var(--text-muted);">Loading…</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transaction Types -->
        <div class="col-md-6">
            <div class="kanso-card" style="padding:0; overflow:hidden; height:100%;">
                <div style="padding:12px 18px; border-bottom:1px solid var(--border-subtle);">
                    <span style="font-size:13px; font-weight:600; color:var(--text);">Transaction Types</span>
                </div>
                <div style="max-height:420px; overflow-y:auto;">
                    <table class="anl-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTypesTable">
                            <tr><td colspan="4" style="text-align:center; color:var(--text-muted);">Loading…</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div><!-- /2×2 grid -->

    <!-- Summary + Filtered Transactions -->
    <div class="kanso-card" style="padding:0; overflow:hidden;">

        <!-- Info strip -->
        <div class="kanso-info-strip">
            <div class="kanso-info-item">
                <div class="kanso-info-label">Total Transactions</div>
                <div class="kanso-info-value" id="totalTransactions">—</div>
            </div>
            <div class="kanso-info-item">
                <div class="kanso-info-label">Total Amount</div>
                <div class="kanso-info-value" id="totalAmount">—</div>
            </div>
            <div class="kanso-info-item">
                <div class="kanso-info-label">Avg Transaction</div>
                <div class="kanso-info-value" id="avgTransaction">—</div>
            </div>
            <div class="kanso-info-item">
                <div class="kanso-info-label">Date Range</div>
                <div class="kanso-info-value" id="dateRange">—</div>
            </div>
        </div>

        <!-- Body -->
        <div style="padding:16px 18px;">

            <!-- Header row -->
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                <span style="font-size:13px; font-weight:600; color:var(--text);">Filtered Transactions (up to 100)</span>
                <div id="bulkEditControls" style="display:none; display:flex; gap:10px; align-items:center;">
                    <span style="font-size:12.5px; color:var(--text-muted);" id="selectedCount">0 selected</span>
                    <button type="button" class="btn-kanso btn-kanso-primary btn-kanso-sm" id="bulkEditBtn">Bulk Edit</button>
                </div>
            </div>

            <!-- Filtered transactions table -->
            <div style="overflow-x:auto;">
                <table class="anl-table">
                    <thead>
                        <tr>
                            <th style="width:40px;">
                                <input type="checkbox" id="selectAllTransactions" title="Select All">
                            </th>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Owner</th>
                            <th>Account</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="filteredTransactionsBody">
                        <tr><td colspan="10" style="text-align:center; color:var(--text-muted);">Loading…</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div><!-- /summary + filtered transactions -->

</div><!-- /kanso-page-wide -->


<!-- Edit Transaction Modal -->
<div class="modal fade kanso-modal" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTransactionForm">
                    <input type="hidden" id="editTransactionId">

                    <!-- Transaction Info -->
                    <div class="modal-section-label">Transaction Info</div>
                    <div class="kanso-form-grid" style="margin-bottom:18px;">
                        <div>
                            <label class="kanso-form-label" for="editDate">Date <span style="color:var(--danger)">*</span></label>
                            <input type="date" class="form-control" id="editDate" required>
                        </div>
                        <div>
                            <label class="kanso-form-label" for="editAmount">Amount <span style="color:var(--danger)">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editAmount" step="0.01" required>
                            </div>
                        </div>
                        <div class="span-2">
                            <label class="kanso-form-label" for="editDescription">Description <span style="color:var(--danger)">*</span></label>
                            <input type="text" class="form-control" id="editDescription" required>
                        </div>
                    </div>

                    <!-- Categorization -->
                    <div class="modal-section-label">Categorization</div>
                    <div class="kanso-form-grid" style="margin-bottom:18px;">
                        <div>
                            <label class="kanso-form-label" for="editCategory">Category <span style="color:var(--danger)">*</span></label>
                            <select class="form-select" id="editCategory" required onchange="loadEditSubcategories()">
                                <option value="">Select category...</option>
                            </select>
                        </div>
                        <div>
                            <label class="kanso-form-label" for="editSubCategory">Subcategory</label>
                            <select class="form-select" id="editSubCategory">
                                <option value="">Select subcategory...</option>
                            </select>
                        </div>
                        <div>
                            <label class="kanso-form-label" for="editType">Type <span style="color:var(--danger)">*</span></label>
                            <select class="form-select" id="editType" required>
                                <option value="">Select type...</option>
                                <option value="Needs">Needs</option>
                                <option value="Wants">Wants</option>
                                <option value="Savings">Savings</option>
                                <option value="Business">Business</option>
                                <option value="Income">Income</option>
                            </select>
                        </div>
                    </div>

                    <!-- Account & Owner -->
                    <div class="modal-section-label">Account &amp; Owner</div>
                    <div class="kanso-form-grid" style="margin-bottom:18px;">
                        <div>
                            <label class="kanso-form-label" for="editOwner">Owner <span style="color:var(--danger)">*</span></label>
                            <select class="form-select" id="editOwner" required>
                                <option value="">Select owner...</option>
                            </select>
                        </div>
                        <div>
                            <label class="kanso-form-label" for="editAccountName">Account <span style="color:var(--danger)">*</span></label>
                            <select class="form-select" id="editAccountName" required>
                                <option value="">Select account...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Business checkbox -->
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="editIsBusiness"
                               style="width:16px; height:16px; accent-color:var(--primary); cursor:pointer;">
                        <label for="editIsBusiness" style="font-size:13.5px; color:var(--text); cursor:pointer; margin:0;">
                            Business Transaction
                        </label>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-kanso btn-kanso-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-kanso btn-kanso-primary" onclick="saveTransactionFromAnalytics()">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Edit Modal -->
<div class="modal fade kanso-modal" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkEditModalLabel">Bulk Edit Transactions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="anl-info-box">
                    Editing <strong><span id="bulkEditCount">0</span> transactions</strong>.
                    Empty fields won't change.
                </div>

                <form id="bulkEditForm">
                    <div style="margin-bottom:14px;">
                        <label class="kanso-form-label" for="bulkEditCategory">Category</label>
                        <select class="kanso-select" id="bulkEditCategory" onchange="updateBulkEditSubcategories()">
                            <option value="">— Don't Change —</option>
                            {% for category in available_categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="margin-bottom:14px;">
                        <label class="kanso-form-label" for="bulkEditSubCategory">Subcategory</label>
                        <select class="kanso-select" id="bulkEditSubCategory">
                            <option value="">— Don't Change —</option>
                        </select>
                    </div>
                    <div style="margin-bottom:14px;">
                        <label class="kanso-form-label" for="bulkEditType">Type</label>
                        <select class="kanso-select" id="bulkEditType">
                            <option value="">— Don't Change —</option>
                            <option value="Needs">Needs</option>
                            <option value="Wants">Wants</option>
                            <option value="Savings">Savings</option>
                            <option value="Business">Business</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                    <div style="margin-bottom:14px;">
                        <label class="kanso-form-label" for="bulkEditAccount">Account</label>
                        <select class="kanso-select" id="bulkEditAccount">
                            <option value="">— Don't Change —</option>
                            {% for account in available_accounts %}
                            <option value="{{ account }}">{{ account }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="margin-bottom:14px;">
                        <label class="kanso-form-label" for="bulkEditOwner">Owner</label>
                        <select class="kanso-select" id="bulkEditOwner">
                            <option value="">— Don't Change —</option>
                            {% for owner in available_owners %}
                            <option value="{{ owner }}">{{ owner }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-kanso btn-kanso-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-kanso btn-kanso-primary" id="saveBulkEdit">
                    Update <span id="bulkEditCountFooter">0</span> Transactions
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Data for JavaScript -->
<script>
window.analyticsData = {
    availableOwners: {{ available_owners | tojson | safe }},
    availableCategories: {{ available_categories | tojson | safe }},
    availableSubcategories: {{ available_subcategories | tojson | safe }},
    availableAccounts: {{ available_accounts | tojson | safe }},
    defaultStartDate: '{{ default_start_date }}',
    defaultEndDate: '{{ default_end_date }}'
};

// YoY toggle: sync .active class on labels when radio changes
document.querySelectorAll('input[name="yoyViewType"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.anl-view-btn').forEach(function(b) { b.classList.remove('active'); });
        this.nextElementSibling.classList.add('active');
    });
});
</script>
{% endblock %}
