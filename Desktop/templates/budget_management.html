{% extends "base.html" %}
{% block extra_css %}
<link href="{{ url_for('static', filename='css/budget.css') }}" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/budget_v2.js') }}"></script>
{% endblock %}
{% block title %}Budget — Kanso{% endblock %}

{% block content %}
<div class="kanso-page-wide">

    <!-- Page Header -->
    <div style="margin-bottom:20px;">
        <div class="kanso-section-label" style="margin-bottom:4px;">Finance</div>
        <h1 style="font-size:22px; font-weight:700; color:var(--text); margin:0;">Budget</h1>
    </div>

    <!-- Info Strip -->
    <div class="kanso-info-strip" style="margin-bottom:20px;">
        <div class="kanso-info-item">
            <div class="kanso-info-label">Total Budget</div>
            <div class="kanso-info-value" id="totalBudget">$0.00</div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Commitments</div>
            <div class="kanso-info-value" id="totalCommitments">$0.00</div>
            <div style="font-size:11px; color:var(--text-faint); margin-top:2px;"><span id="commitmentCount">0</span> Fixed Expenses</div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Living Budget</div>
            <div class="kanso-info-value" id="livingBudget">$0.00</div>
            <div style="font-size:11px; color:var(--text-faint); margin-top:2px;">Budget − Commitments</div>
        </div>
        <div class="kanso-info-item">
            <div class="kanso-info-label">Unexpected</div>
            <div class="kanso-info-value" id="totalUnexpectedExpenses">$0.00</div>
            <div style="font-size:11px; color:var(--text-faint); margin-top:2px;" id="unexpectedMonthSummary">{{ selected_year }}-{{ "%02d"|format(selected_month) }}</div>
        </div>
    </div>

    <!-- Main Card with tabs -->
    <div class="kanso-card" style="padding:0; overflow:hidden;">

        <!-- Tab Navigation -->
        <div class="bgt-tab-nav">
            <button class="bgt-tab-btn active" data-tab="subcategories" onclick="switchBudgetTab(this)">
                Subcategory Budgets
            </button>
            <button class="bgt-tab-btn" data-tab="commitments" onclick="switchBudgetTab(this)">
                Commitments
            </button>
            <button class="bgt-tab-btn" data-tab="unexpected" onclick="switchBudgetTab(this)">
                Unexpected Expenses
            </button>
        </div>

        <!-- ── SUBCATEGORY BUDGETS PANEL ── -->
        <div id="tab-subcategories">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border-subtle);">
                <span style="font-size:14px; font-weight:600; color:var(--text);">Subcategory Budgets</span>
                <div style="display:flex; gap:6px; align-items:center;">
                    <!-- Collapse / Expand all -->
                    <button class="debt-action-btn" onclick="collapseAllCategories()" title="Collapse all" style="color:var(--text-faint);">
                        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M2 6l6-5 6 5"/><path d="M2 11l6-5 6 5"/>
                        </svg>
                    </button>
                    <button class="debt-action-btn" onclick="expandAllCategories()" title="Expand all" style="color:var(--text-faint);">
                        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M2 5l6 5 6-5"/><path d="M2 10l6 5 6-5"/>
                        </svg>
                    </button>
                    <div style="width:1px; height:18px; background:var(--border-subtle); margin:0 2px;"></div>
                    <button class="btn-kanso btn-kanso-primary btn-kanso-sm" onclick="saveAllSubcategoryBudgets()">Save All</button>
                    <button class="btn-kanso btn-kanso-ghost btn-kanso-sm" onclick="syncSubcategoryTemplates()">Sync Categories</button>
                </div>
            </div>
            <div style="padding:16px 18px;">
                <div id="subcategoryLoadingMessage" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2" style="color:var(--text-muted); font-size:13px;">Loading subcategory budgets…</p>
                </div>
                <div id="subcategoryBudgetContainer" style="display:none;">
                    <!-- Subcategory budgets rendered by JS -->
                </div>
            </div>
        </div>

        <!-- ── COMMITMENTS PANEL ── -->
        <div id="tab-commitments" style="display:none;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border-subtle);">
                <div>
                    <span style="font-size:14px; font-weight:600; color:var(--text);">Monthly Commitments</span>
                    <span style="display:block; font-size:12px; color:var(--text-faint); margin-top:2px;">Track fixed and variable recurring expenses</span>
                </div>
                <button class="btn-kanso btn-kanso-primary btn-kanso-sm" onclick="showAddCommitmentModal()">Add Commitment</button>
            </div>
            <div style="padding:16px 18px;">
                <div id="commitmentLoadingMessage" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2" style="color:var(--text-muted); font-size:13px;">Loading commitments…</p>
                </div>

                <div id="commitmentsContainer" style="display:none;">
                    <!-- Commitments rendered by JS -->
                </div>

                <div id="noCommitments" class="bgt-empty-state" style="display:none;">
                    No commitments added yet.
                    <div style="margin-top:12px;">
                        <button class="btn-kanso btn-kanso-primary" onclick="showAddCommitmentModal()">Add Your First Commitment</button>
                    </div>
                </div>
            </div>

            <!-- Commitment Summaries — edge-to-edge, outside the padded div -->
            <div id="commitmentSummaries" style="display:none; border-top:1px solid var(--border-subtle);">
                <!-- Two tables side by side, full width, no gutter -->
                <div style="display:grid; grid-template-columns:1fr 1fr;">
                    <div style="border-right:1px solid var(--border-subtle);">
                        <div style="padding:10px 14px; border-bottom:1px solid var(--border-subtle);">
                            <span style="font-size:13px; font-weight:600; color:var(--text);">By Category</span>
                        </div>
                        <div style="overflow-y:auto; max-height:300px;">
                            <table class="anl-table">
                                <thead>
                                    <tr>
                                        <th style="cursor:pointer;" onclick="sortCommitmentCategory('category', 'category')">
                                            Category <i class="fas fa-sort" id="sort-icon-category-category"></i>
                                        </th>
                                        <th style="cursor:pointer; text-align:right;" onclick="sortCommitmentCategory('count', 'category')">
                                            Count <i class="fas fa-sort" id="sort-icon-category-count"></i>
                                        </th>
                                        <th style="cursor:pointer; text-align:right;" onclick="sortCommitmentCategory('total', 'category')">
                                            Total <i class="fas fa-sort" id="sort-icon-category-total"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="commitmentsByCategoryBody">
                                    <tr><td colspan="3" style="text-align:center; color:var(--text-muted);">Loading…</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <div style="padding:10px 14px; border-bottom:1px solid var(--border-subtle);">
                            <span style="font-size:13px; font-weight:600; color:var(--text);">By Subcategory</span>
                        </div>
                        <div style="overflow-y:auto; max-height:300px;">
                            <table class="anl-table">
                                <thead>
                                    <tr>
                                        <th style="cursor:pointer;" onclick="sortCommitmentCategory('category', 'subcategory')">
                                            Category <i class="fas fa-sort" id="sort-icon-subcategory-category"></i>
                                        </th>
                                        <th style="cursor:pointer;" onclick="sortCommitmentCategory('subcategory', 'subcategory')">
                                            Subcategory <i class="fas fa-sort" id="sort-icon-subcategory-subcategory"></i>
                                        </th>
                                        <th style="cursor:pointer; text-align:right;" onclick="sortCommitmentCategory('count', 'subcategory')">
                                            Count <i class="fas fa-sort" id="sort-icon-subcategory-count"></i>
                                        </th>
                                        <th style="cursor:pointer; text-align:right;" onclick="sortCommitmentCategory('total', 'subcategory')">
                                            Total <i class="fas fa-sort" id="sort-icon-subcategory-total"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="commitmentsBySubcategoryBody">
                                    <tr><td colspan="4" style="text-align:center; color:var(--text-muted);">Loading…</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Timeline chart -->
                <div style="border-top:1px solid var(--border-subtle);">
                    <div style="padding:10px 14px; border-bottom:1px solid var(--border-subtle);">
                        <span style="font-size:13px; font-weight:600; color:var(--text);">Commitment Payment Timeline</span>
                        <span style="display:block; font-size:12px; color:var(--text-faint); margin-top:2px;">When commitments are due throughout the month</span>
                    </div>
                    <div style="padding:16px 18px;">
                        <canvas id="commitmentTimelineChart" style="max-height:300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── UNEXPECTED EXPENSES PANEL ── -->
        <div id="tab-unexpected" style="display:none;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border-subtle); flex-wrap:wrap; gap:10px;">
                <span style="font-size:14px; font-weight:600; color:var(--text);">
                    Unexpected Expenses — <span id="unexpectedMonthLabel">{{ selected_year }}-{{ "%02d"|format(selected_month) }}</span>
                </span>
                <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                    <select class="kanso-select" id="unexpectedMonthSelect" style="width:auto;" onchange="changeUnexpectedMonth()">
                        {% for month_num, month_name in [(1, 'Jan'), (2, 'Feb'), (3, 'Mar'), (4, 'Apr'), (5, 'May'), (6, 'Jun'), (7, 'Jul'), (8, 'Aug'), (9, 'Sep'), (10, 'Oct'), (11, 'Nov'), (12, 'Dec')] %}
                        <option value="{{ month_num }}" {{ 'selected' if month_num == selected_month else '' }}>{{ month_name }}</option>
                        {% endfor %}
                    </select>
                    <select class="kanso-select" id="unexpectedYearSelect" style="width:auto;" onchange="changeUnexpectedMonth()">
                        {% for year in available_years %}
                        <option value="{{ year }}" {{ 'selected' if year == selected_year else '' }}>{{ year }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn-kanso btn-kanso-primary btn-kanso-sm" onclick="showAddUnexpectedExpenseModal()">Add Unexpected Expense</button>
                </div>
            </div>
            <div style="padding:16px 18px;">
                <div id="unexpectedLoadingMessage" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2" style="color:var(--text-muted); font-size:13px;">Loading unexpected expenses…</p>
                </div>

                <div id="unexpectedExpensesTableContainer" style="display:none; overflow-x:auto;">
                    <table class="anl-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Added On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="unexpectedExpensesTableBody"></tbody>
                    </table>
                </div>

                <div id="noUnexpectedExpenses" class="bgt-empty-state" style="display:none;">
                    No unexpected expenses for this month yet.
                </div>
            </div>
        </div>

    </div><!-- /kanso-card -->

</div><!-- /kanso-page-wide -->

<!-- ── Recommendations Modal ── -->
<div class="modal fade" id="recommendationsModal" tabindex="-1">
    <div class="modal-dialog modal-xl kanso-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Budget Recommendations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="recommendationsLoading" class="text-center py-4">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2" style="color:var(--text-muted); font-size:13px;">Analyzing your spending history…</p>
                </div>
                <div id="recommendationsContent" style="display:none;">
                    <div class="anl-info-box" style="margin-bottom:12px;">
                        <strong>How it works:</strong> ML-powered recommendations analyze your spending patterns using historical data to predict future budget needs with high accuracy.
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="anl-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllRecommendations" onchange="toggleAllRecommendations(this.checked)"></th>
                                    <th>Category</th>
                                    <th>Subcategory</th>
                                    <th>Current Budget</th>
                                    <th>Recommended</th>
                                    <th>6mo Avg</th>
                                    <th>3mo Avg</th>
                                    <th>Last Month</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="recommendationsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-kanso btn-kanso-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-kanso btn-kanso-primary" onclick="applySelectedRecommendations()">Apply Selected Recommendations</button>
            </div>
        </div>
    </div>
</div>

<!-- ── Add/Edit Commitment Modal ── -->
<div class="modal fade" id="commitmentModal" tabindex="-1">
    <div class="modal-dialog kanso-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commitmentModalLabel">Add Commitment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="commitmentForm">
                    <input type="hidden" id="commitmentId" value="">
                    <div class="modal-section-label">Commitment Details</div>
                    <div class="kanso-form-grid">
                        <div style="grid-column:span 2;">
                            <label class="kanso-form-label" for="commitmentName">Name</label>
                            <input type="text" class="kanso-input" id="commitmentName" required placeholder="e.g., Rent, Car Payment, Insurance">
                        </div>
                        <div>
                            <label class="kanso-form-label" for="commitmentCategory">Category</label>
                            <select class="kanso-select" id="commitmentCategory" required onchange="loadSubcategoriesForCommitment()">
                                <option value="">Select category…</option>
                            </select>
                        </div>
                        <div>
                            <label class="kanso-form-label" for="commitmentSubCategory">Subcategory</label>
                            <select class="kanso-select" id="commitmentSubCategory" required>
                                <option value="">Select subcategory…</option>
                            </select>
                        </div>
                        <div>
                            <label class="kanso-form-label" for="commitmentAmount">Estimated Amount</label>
                            <div class="kanso-input-group">
                                <span class="kanso-input-prefix">$</span>
                                <input type="number" class="kanso-input has-prefix" id="commitmentAmount" step="0.01" min="0" required placeholder="0.00">
                            </div>
                        </div>
                        <div>
                            <label class="kanso-form-label" for="commitmentDueDay">Due Day of Month</label>
                            <input type="number" class="kanso-input" id="commitmentDueDay" min="1" max="31" required placeholder="15">
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:12px;">
                        <input type="checkbox" id="commitmentIsFixed" style="accent-color:var(--primary);" checked>
                        <label for="commitmentIsFixed" style="font-size:13px; color:var(--text-muted); cursor:pointer;">
                            Fixed amount (uncheck if amount varies monthly)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-kanso btn-kanso-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-kanso btn-kanso-primary" onclick="saveCommitment()">Save Commitment</button>
            </div>
        </div>
    </div>
</div>

<!-- ── Add/Edit Unexpected Expense Modal ── -->
<div class="modal fade" id="unexpectedExpenseModal" tabindex="-1">
    <div class="modal-dialog kanso-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unexpectedExpenseModalLabel">Add Unexpected Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="unexpectedExpenseForm">
                    <input type="hidden" id="unexpectedExpenseId" value="">
                    <div class="modal-section-label">Expense Details</div>
                    <div class="kanso-form-grid">
                        <div style="grid-column:span 2;">
                            <label class="kanso-form-label" for="unexpectedCategory">Category</label>
                            <select class="kanso-select" id="unexpectedCategory" required>
                                <option value="">Select category…</option>
                            </select>
                        </div>
                        <div style="grid-column:span 2;">
                            <label class="kanso-form-label" for="unexpectedDescription">Description</label>
                            <input type="text" class="kanso-input" id="unexpectedDescription" required placeholder="e.g., Car repair, Medical emergency">
                        </div>
                        <div>
                            <label class="kanso-form-label" for="unexpectedAmount">Amount</label>
                            <div class="kanso-input-group">
                                <span class="kanso-input-prefix">$</span>
                                <input type="number" class="kanso-input has-prefix" id="unexpectedAmount" step="0.01" min="0" required placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-kanso btn-kanso-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-kanso btn-kanso-primary" onclick="saveUnexpectedExpense()">Save Expense</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize the page with selected year and month from server
window.SELECTED_YEAR = {{ selected_year }};
window.SELECTED_MONTH = {{ selected_month }};

function switchBudgetTab(btn) {
    document.querySelectorAll('.bgt-tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    ['subcategories', 'commitments', 'unexpected'].forEach(id => {
        document.getElementById('tab-' + id).style.display = id === tab ? 'block' : 'none';
    });
    if (tab === 'commitments') loadCommitments();
    if (tab === 'unexpected') loadUnexpectedExpenses();
}

function collapseAllCategories() {
    document.querySelectorAll('#subcategoryBudgetContainer [data-bs-toggle="collapse"]').forEach(btn => {
        const target = btn.getAttribute('data-bs-target');
        if (!target) return;
        const el = document.querySelector(target);
        if (el && el.classList.contains('show')) {
            (bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, {toggle: false})).hide();
        }
    });
}

function expandAllCategories() {
    document.querySelectorAll('#subcategoryBudgetContainer [data-bs-toggle="collapse"]').forEach(btn => {
        const target = btn.getAttribute('data-bs-target');
        if (!target) return;
        const el = document.querySelector(target);
        if (el && !el.classList.contains('show')) {
            (bootstrap.Collapse.getInstance(el) || new bootstrap.Collapse(el, {toggle: false})).show();
        }
    });
}
</script>

{% endblock %}
