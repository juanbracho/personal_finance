<!DOCTYPE html>
<html lang="en" data-theme="warm-ink">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Kanso{% endblock %}</title>

    <!-- Bootstrap (kept for grid + JS components still used in some pages) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Kanso Design System -->
    <link href="{{ url_for('static', filename='css/kanso.css') }}" rel="stylesheet">

    <!-- Page-specific CSS -->
    {% block extra_css %}{% endblock %}

    <!-- Plotly.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>

    <!-- API key injected server-side -->
    <script>
        window.FINANCE_API_KEY = "{{ config.get('API_SECRET_KEY', '') }}";
    </script>

    <!-- Apply saved theme before first paint (prevents flash) -->
    <script>
        (function() {
            var t = localStorage.getItem('kanso-theme') || 'warm-ink';
            document.documentElement.setAttribute('data-theme', t);
        })();
    </script>
</head>
<body>

<!-- ── Navigation ── -->
<nav class="kanso-nav">

    <!-- Brand -->
    <a class="kanso-nav-brand" href="{{ url_for('dashboards.dashboard') }}">
        <img src="{{ url_for('static', filename='img/kanso-icon.svg') }}"
             class="kanso-nav-icon" alt="Kanso">
        <div class="kanso-nav-wordmark">
            <span class="kanso-nav-name">Kanso</span>
            <span class="kanso-nav-sub">Mindful money tracking</span>
        </div>
    </a>

    <!-- Nav links -->
    <ul class="kanso-nav-links">
        <li>
            <a href="{{ url_for('dashboards.dashboard') }}"
               class="{{ 'active' if request.endpoint in ['dashboards.dashboard', 'dashboards.overview'] }}">
                Overview
            </a>
        </li>
        <li>
            <a href="{{ url_for('transactions.list_transactions') }}"
               class="{{ 'active' if 'transactions' in request.endpoint }}">
                Transactions
            </a>
        </li>
        <li>
            <a href="{{ url_for('budgets.budget_management') }}"
               class="{{ 'active' if 'budgets' in request.endpoint }}">
                Budget
            </a>
        </li>
        <li>
            <a href="{{ url_for('debts.list_debts') }}"
               class="{{ 'active' if 'debts' in request.endpoint }}">
                Debts
            </a>
        </li>
        <li>
            <a href="{{ url_for('analytics.analytics_dashboard') }}"
               class="{{ 'active' if 'analytics' in request.endpoint }}">
                Analytics
            </a>
        </li>
    </ul>

    <!-- Right actions -->
    <div class="kanso-nav-actions">

        <!-- 3-theme toggle -->
        <div class="theme-toggle" title="Switch theme">
            <button class="theme-btn" data-theme-target="warm-ink" title="Warm Ink" onclick="setTheme('warm-ink')">
                <!-- Candle / ink flame -->
                <svg viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="7" cy="8.5" r="4" fill="var(--wants)" opacity="0.85"/>
                    <path d="M7 4.5 C7 4.5 8.5 2.5 7 1 C5.5 2.5 7 4.5 7 4.5Z" fill="var(--primary)" opacity="0.9"/>
                </svg>
            </button>
            <button class="theme-btn" data-theme-target="indigo" title="Indigo" onclick="setTheme('indigo')">
                <!-- Moon -->
                <svg viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 7A4 4 0 1 1 7 3.2 3 3 0 0 0 10 7Z" fill="#7B9ED9" opacity="0.9"/>
                </svg>
            </button>
            <button class="theme-btn" data-theme-target="washi" title="Washi Paper" onclick="setTheme('washi')">
                <!-- Sun -->
                <svg viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="7" cy="7" r="3" fill="#8C6A3F" opacity="0.9"/>
                    <g stroke="#8C6A3F" stroke-width="1.2" stroke-linecap="round" opacity="0.7">
                        <line x1="7" y1="1" x2="7" y2="2.5"/>
                        <line x1="7" y1="11.5" x2="7" y2="13"/>
                        <line x1="1" y1="7" x2="2.5" y2="7"/>
                        <line x1="11.5" y1="7" x2="13" y2="7"/>
                        <line x1="2.9" y1="2.9" x2="3.9" y2="3.9"/>
                        <line x1="10.1" y1="10.1" x2="11.1" y2="11.1"/>
                        <line x1="11.1" y1="2.9" x2="10.1" y2="3.9"/>
                        <line x1="3.9" y1="10.1" x2="2.9" y2="11.1"/>
                    </g>
                </svg>
            </button>
        </div>

        <!-- Settings -->
        <a href="{{ url_for('settings.index') }}"
           class="kanso-signout {{ 'text-primary-k' if 'settings' in request.endpoint }}"
           style="{{ 'color: var(--primary)' if 'settings' in request.endpoint }}"
           title="Settings">
            <i class="fas fa-sliders-h" style="font-size:13px;"></i>
        </a>

        <!-- Sign out -->
        {% if session.get('logged_in') %}
        <a href="{{ url_for('auth.logout') }}" class="kanso-signout" title="Sign out">
            Sign out
        </a>
        {% endif %}
    </div>
</nav>

<!-- ── Main Content ── -->
<div class="kanso-main" style="min-height: calc(100vh - 56px - 60px);">

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div style="max-width:860px; margin:0 auto; padding:1rem 1.5rem 0;">
            {% for category, message in messages %}
            <div class="kanso-flash {{ 'danger' if category == 'error' else category }}">
                {% if category == 'success' %}<i class="fas fa-check-circle"></i>
                {% elif category in ['error', 'danger'] %}<i class="fas fa-exclamation-circle"></i>
                {% else %}<i class="fas fa-info-circle"></i>{% endif %}
                {{ message }}
                <button class="kanso-flash-close" onclick="this.parentElement.remove()">×</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
</div>

<!-- ── Footer ── -->
<footer class="kanso-footer">
    Kanso &nbsp;·&nbsp; Mindful money tracking
</footer>

<!-- Bootstrap JS (still needed for some existing components) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<!-- Main JS -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

<!-- Theme engine -->
<script>
    function setTheme(name) {
        document.documentElement.setAttribute('data-theme', name);
        localStorage.setItem('kanso-theme', name);
        // Sync nav toggle buttons
        document.querySelectorAll('.theme-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.themeTarget === name);
        });
        // Sync settings picker cards (no-op on pages without them)
        document.querySelectorAll('.theme-option').forEach(function(el) {
            el.classList.toggle('active', el.dataset.themePick === name);
        });
    }

    // Init: apply saved theme and mark active buttons
    document.addEventListener('DOMContentLoaded', function() {
        var current = localStorage.getItem('kanso-theme') || 'warm-ink';
        setTheme(current);
    });
</script>

<!-- Page-specific JS -->
{% block extra_js %}{% endblock %}
</body>
</html>
